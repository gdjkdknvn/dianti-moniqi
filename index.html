<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ²‰æµ¸å¼ç”µæ¢¯ç¾¤æ§æ¨¡æ‹Ÿå™¨ V8 æœ€ç»ˆå®Œç»“ç‰ˆ</title>
  <style>
    :root {
      --metal-light: #e0e0e0;
      --metal-dark: #5a5a5a;
      --led-off: #221111;
      --led-on: #ff3333;
      --btn-light: #fff8dc;
    }
    body {
      margin: 0;
      background-color: #1a1a1a;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
      user-select: none;
      color: #eee;
    }
    .layout { display: flex; gap: 16px; align-items: stretch; }

    .elevator-shaft {
      width: 800px; height: 90vh; background: linear-gradient(to bottom, #333, #111);
      position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.8);
      border: 20px solid #444; border-radius: 10px; display: flex; overflow: hidden;
    }
    .interior-back {
      position: absolute; width: 100%; height: 100%;
      background:
        linear-gradient(90deg, rgba(0,0,0,0.3) 1px, transparent 1px),
        linear-gradient(#888, #555);
      background-size: 100px 100%, 100% 100%;
      z-index: 1; transition: transform 0.2s;
    }
    .ad-screen {
      position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
      width: 300px; height: 180px; background: #000; border: 4px solid #333;
      border-radius: 4px; z-index: 1; display: flex; justify-content: center; align-items: center;
      color: #fff; font-size: 14px; text-align: center; overflow: hidden;
      box-shadow: 0 0 10px rgba(255,255,255,0.1);
    }
    .door-container {
      position: absolute; top: 0; left: 15%; width: 60%; height: 100%;
      z-index: 10; display: flex;
    }
    .door {
      width: 50%; height: 100%;
      background: repeating-linear-gradient(90deg,#c0c0c0,#c0c0c0 50px,#b0b0b0 50px,#b0b0b0 52px);
      border: 1px solid #777; position: relative; transition: transform 2s ease-in-out;
      box-shadow: 5px 0 15px rgba(0,0,0,0.5);
    }
    .door.left { border-right: 2px solid #555; }
    .door.right { border-left: 2px solid #555; }
    .door-container.open .door.left { transform: translateX(-95%); }
    .door-container.open .door.right { transform: translateX(95%); }

    .control-panel {
      position: absolute; right: 0; top: 0; width: 25%; height: 100%;
      background: linear-gradient(135deg, #4a4a4a, #2a2a2a);
      z-index: 20; border-left: 5px solid #111; padding: 20px; box-sizing: border-box;
      display: flex; flex-direction: column; align-items: center;
    }

    .group-tabs { width: 100%; display: flex; gap: 6px; margin-bottom: 8px; flex-wrap: wrap; }
    .elevator-tab {
      flex: 1; min-width: 34px; padding: 4px 0; background: #222; border-radius: 8px;
      text-align: center; font-size: 12px; color: #aaa; border: 1px solid #444; cursor: pointer;
    }
    .elevator-tab.active {
      background: #ffcc33; color: #000; border-color: #ffcc33;
      box-shadow: 0 0 6px rgba(255,204,51,0.6);
    }

    .display-screen {
      width: 100%; height: 80px; background: #000; border: 2px solid #666;
      margin-bottom: 10px; border-radius: 5px; display: flex; justify-content: center; align-items: center;
      gap: 10px; box-shadow: inset 0 0 10px rgba(255,0,0,0.2); position: relative;
    }
    .floor-num {
      font-family: 'Courier New', monospace; font-size: 50px; color: var(--led-off);
      font-weight: bold;
    }
    .floor-num.active { color: var(--led-on); text-shadow: 0 0 10px var(--led-on); }
    .direction-arrow { font-size: 40px; color: var(--led-off); }
    .direction-arrow.active { color: #00ff00; text-shadow: 0 0 10px #00ff00; }
    .display-sub {
      position: absolute; bottom: 4px; left: 8px; right: 8px; font-size: 11px; color: #9f9;
      display: flex; justify-content: space-between; opacity: 0.85;
    }

    .active-elevator-info { width: 100%; font-size: 12px; color: #ddd; margin-bottom: 8px; line-height: 1.4; }

    .button-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; }

    .elevator-btn {
      width: 60px; height: 60px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ddd, #999);
      border: 3px solid #666; box-shadow: 2px 2px 5px rgba(0,0,0,0.5), inset 1px 1px 2px rgba(255,255,255,0.8);
      font-size: 24px; font-weight: bold; color: #333; cursor: pointer;
      display: flex; justify-content: center; align-items: center; transition: all 0.1s; margin: 0 auto;
    }
    .elevator-btn:active { transform: scale(0.95); }
    .elevator-btn.pressed {
      box-shadow: 0 0 15px var(--btn-light), inset 1px 1px 2px rgba(255,255,255,0.8);
      border-color: #ffaa00; color: #ff5500;
      background: radial-gradient(circle at 30% 30%, #fff, #ffddaa);
      text-shadow: 0 0 5px orange;
    }
    .elevator-btn.disabled-btn,
    .hall-btn.disabled-btn {
      opacity: 0.25 !important;
      filter: grayscale(0.7);
      pointer-events: none;
    }

    .func-btn-group { display: flex; gap: 10px; margin-top: 20px; width: 100%; justify-content: space-around; }
    .func-btn { font-size: 18px; width: 50px; height: 50px; }

    .info-plate {
      margin-top: auto; border: 1px solid #666; background: #ccc; padding: 10px; font-size: 10px; color: #000;
      width: 100%; text-align: center;
    }

    .shaking { animation: shake 0.5s infinite; }
    @keyframes shake {
      0% { transform: translateY(0); }
      25% { transform: translateY(1px); }
      50% { transform: translateY(0); }
      75% { transform: translateY(-1px); }
      100% { transform: translateY(0); }
    }

    .status-log {
      position: absolute; top: 20px; left: 20px; color: #0f0; font-family: monospace;
      background: rgba(0,0,0,0.7); padding: 10px; border: 1px solid #0f0; pointer-events: none;
      z-index: 100; font-size: 12px; line-height: 1.4; min-width: 260px;
    }

    .floor-panel {
      width: 200px; height: 90vh; background: #111; border: 2px solid #444; border-radius: 10px;
      padding: 8px; box-sizing: border-box; display: flex; flex-direction: column; font-size: 12px;
    }
    .floor-panel-title { text-align: center; font-weight: bold; margin-bottom: 6px; }

    .floor-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 2px 0; gap: 4px;
    }
    .floor-label { width: 24px; text-align: center; color: #ccc; }

    .hall-btn {
      width: 20px; height: 20px; border-radius: 4px; border: 1px solid #555; background: #222;
      color: #888; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px;
    }
    .hall-btn.disabled { opacity: 0.2; pointer-events: none; }
    .hall-btn.active {
      background: #ffcc33; color: #000; border-color: #ffcc33; box-shadow: 0 0 4px #ffcc33;
    }

    .heatbar { flex: 1; height: 6px; border-radius: 3px; background: #222; overflow: hidden; }
    .heatbar-inner {
      height: 100%; width: 0%; background: linear-gradient(to right,#4caf50,#ff9800,#f44336);
      transition: width 0.2s;
    }
    .mood-icon { width: 18px; text-align: center; }

    .group-panel {
      width: 320px; height: 90vh; background: #111; border: 2px solid #444; border-radius: 10px;
      padding: 8px; box-sizing: border-box; display: flex; flex-direction: column; font-size: 12px;
    }

    .side-tabs { display:flex; gap:6px; margin-bottom:6px; }
    .side-tab {
      flex:1; text-align:center; font-size:12px; padding:6px 0; cursor:pointer;
      background:#1c1c1c; border:1px solid #333; border-radius:8px; color:#bbb;
    }
    .side-tab.active { background:#64b5f6; color:#000; border-color:#64b5f6; box-shadow:0 0 8px rgba(100,181,246,0.7); }

    .side-section { display:none; flex-direction:column; height:100%; }
    .side-section.active { display:flex; }

    .group-header { text-align: center; font-weight: bold; margin-bottom: 4px; }

    .elevator-list {
      display: flex; flex-direction: column; gap: 4px; margin-bottom: 6px; max-height: 120px; overflow-y: auto;
    }
    .elevator-card {
      padding: 4px 6px; border-radius: 6px; background: #1c1c1c; border: 1px solid #333; cursor: pointer;
    }
    .elevator-card.active { border-color: #ffcc33; box-shadow: 0 0 6px rgba(255,204,51,0.7); }
    .elevator-card-title { font-size: 12px; font-weight: bold; margin-bottom: 2px; }
    .elevator-card-body { display: flex; justify-content: space-between; font-size: 11px; }

    .group-settings { margin-top: 4px; padding-top: 4px; border-top: 1px solid #333; }
    .group-settings label { display: block; margin-bottom: 4px; }
    .group-settings input[type="number"], .group-settings select {
      width: 100%; font-size: 11px; padding: 3px 4px; background: #222; border: 1px solid #444;
      color: #eee; border-radius: 4px; box-sizing: border-box;
    }
    .group-settings input[type="range"] { width: 100%; }
    .group-settings .inline { display: flex; align-items: center; gap: 4px; font-size: 11px; }
    .lock-all { opacity: 0.45; pointer-events: none; }

    .events-log {
      margin-top: 4px; padding-top: 4px; border-top: 1px solid #333; flex: 1; overflow-y: auto;
      font-family: monospace; font-size: 11px;
    }
    .event-line { margin-bottom: 2px; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
    .event-line.info { color: #ccc; }
    .event-line.warn { color: #ff9800; }
    .event-line.error { color: #ff5252; }
    .event-line.say { color: #9ad; }

    .career-panel {
      border: 1px solid #333; border-radius: 6px; padding: 6px; background: #181818;
      margin-bottom: 4px; font-size: 11px;
    }
    .career-header { font-weight: bold; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; }
    .career-row { margin-bottom: 3px; display: flex; align-items: center; justify-content: space-between; gap: 4px; flex-wrap: wrap; }
    .career-row span.value { font-weight: bold; color: #ffeb3b; }
    .career-small-btn {
      border-radius: 4px; border: 1px solid #555; background: #222; color: #eee;
      padding: 0 6px; cursor: pointer; font-size: 10px;
    }
    .career-small-btn:hover { background: #444; }
    .career-main-btn {
      border-radius: 4px; border: 1px solid #666; background: #333; color: #eee;
      padding: 4px 8px; cursor: pointer; font-size: 11px; width: 100%;
    }
    .career-main-btn:hover { background: #555; }

    .career-rep-bar { flex: 1; height: 6px; border-radius: 3px; background: #222; overflow: hidden; margin-left: 4px; }
    .career-rep-inner { height: 100%; width: 50%; background: linear-gradient(to right,#f44336,#ffeb3b,#4caf50); transition: width 0.2s; }

    .policy-panel{
      border-top:1px dashed #333; margin-top:6px; padding-top:6px;
      display:flex; flex-direction:column; gap:6px;
    }
    .policy-title{ font-weight:bold; color:#ffd54f; }
    .policy-item{
      border:1px solid #333; border-radius:6px; padding:6px; background:#141414;
      display:flex; flex-direction:column; gap:4px;
    }
    .policy-row{
      display:flex; justify-content:space-between; align-items:center; gap:6px;
    }
    .policy-desc{ font-size:10px; color:#bbb; line-height:1.4; }
    .policy-btn{
      border:1px solid #666; background:#222; color:#eee; font-size:11px; padding:4px 6px;
      border-radius:6px; cursor:pointer;
    }
    .policy-btn.on{
      background:#81c784; color:#000; border-color:#81c784; box-shadow:0 0 6px rgba(129,199,132,0.5);
    }
    .policy-btn.disabled{ opacity:.4; pointer-events:none; }

    .tech-panel {
      border-top: 1px dashed #333; margin-top: 6px; padding-top: 6px;
      display: flex; flex-direction: column; gap: 6px;
    }
    .tech-item { border: 1px solid #333; border-radius: 6px; padding: 6px; background: #141414; }
    .tech-title { font-weight: bold; color: #90caf9; display:flex; justify-content:space-between; }
    .tech-desc { color:#bbb; margin-top:2px; font-size:10px; line-height:1.4; }
    .tech-btn { margin-top:4px; width:100%; font-size:11px; padding:4px 6px; border:1px solid #555; border-radius:6px; background:#222; color:#eee; cursor:pointer;}
    .tech-btn:hover{ background:#333; }
    .tech-btn.disabled{ opacity:.4; pointer-events:none; }

    .mode-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85);
      display: flex; justify-content: center; align-items: center; z-index: 1000;
    }
    .mode-dialog {
      background: #202020; padding: 24px 28px; border-radius: 12px; border: 1px solid #555;
      max-width: 420px; width: 90%; box-shadow: 0 0 20px rgba(0,0,0,0.8); text-align: center;
    }
    .mode-dialog h1 { margin: 0 0 8px; font-size: 20px; }
    .mode-dialog p { margin: 4px 0; font-size: 13px; color: #ccc; }
    .mode-buttons { display: flex; gap: 10px; margin: 14px 0; flex-wrap: wrap; justify-content: center; }
    .mode-btn {
      flex: 1; min-width: 120px; border-radius: 999px; border: none; padding: 10px 14px;
      font-size: 14px; cursor: pointer; font-weight: bold;
    }
    .mode-btn-career { background: linear-gradient(135deg,#ffb300,#ff6f00); color: #000; box-shadow: 0 0 10px rgba(255,193,7,0.7); }
    .mode-btn-free { background: linear-gradient(135deg,#64b5f6,#1976d2); color: #fff; box-shadow: 0 0 10px rgba(33,150,243,0.6); }
    .mode-tip { font-size: 12px; color: #aaa; }
    .mode-dialog h2 { margin-top: 0; font-size: 18px; }

    .story-panel { display:flex; flex-direction:column; gap:6px; height:100%; }
    .story-queue {
      border:1px solid #333; border-radius:8px; background:#151515; padding:6px; max-height:180px; overflow:auto;
      font-size:11px;
    }
    .queue-item {
      padding:4px 6px; border-radius:6px; border:1px solid #222; margin-bottom:4px; cursor:pointer; background:#1c1c1c;
    }
    .queue-item.active { border-color:#ffcc33; box-shadow:0 0 6px rgba(255,204,51,0.7); }
    .story-current {
      flex:1; border:1px solid #333; border-radius:8px; background:#0f0f0f; padding:8px; display:flex; flex-direction:column; gap:8px;
    }
    .story-title { font-weight:bold; font-size:13px; color:#ffd54f; }
    .story-desc { font-size:12px; color:#ddd; line-height:1.5; white-space:pre-wrap; }
    .story-options { display:flex; flex-direction:column; gap:6px; margin-top:auto; }
    .story-btn {
      border:1px solid #555; background:#222; color:#eee; font-size:12px; padding:8px; border-radius:8px; cursor:pointer; text-align:left;
    }
    .story-btn:hover { background:#333; }
    .story-hint { font-size:11px; color:#aaa; }

    .building-panel { display:flex; flex-direction:column; gap:6px; height:100%; }
    .building-buttons { display:flex; flex-wrap:wrap; gap:6px; }
    .building-btn {
      flex:1; min-width:70px; text-align:center; padding:6px 0; border-radius:8px; cursor:pointer;
      border:1px solid #333; background:#1c1c1c; color:#bbb; font-size:12px;
    }
    .building-btn.active { background:#81c784; color:#000; border-color:#81c784; box-shadow:0 0 8px rgba(129,199,132,0.6); }
    .building-card {
      border:1px solid #333; border-radius:8px; background:#151515; padding:8px; font-size:12px; line-height:1.5;
      display:flex; flex-direction:column; gap:6px;
    }
    .building-card select {
      width:100%; padding:4px; border-radius:6px; background:#222; color:#eee; border:1px solid #444; font-size:12px;
    }
    .building-tip { font-size:11px; color:#aaa; }

    /* è‡ªç”±æ¨¡å¼å·¥å…·ç®± */
    .free-tools{
      border-top:1px solid #333; margin-top:6px; padding-top:6px; display:none; flex-direction:column; gap:6px;
    }
    .free-tools-title{ font-weight:bold; color:#64b5f6; }
    .free-tools-buttons{ display:flex; flex-wrap:wrap; gap:6px; }
    .free-tool-btn{
      flex:1; min-width:90px; text-align:center; padding:6px 0; border-radius:8px; cursor:pointer;
      border:1px solid #333; background:#1c1c1c; color:#ddd; font-size:12px;
    }
    .free-tool-btn:hover{ background:#2a2a2a; }
  </style>
</head>
<body>

  <!-- æ¨¡å¼é€‰æ‹© -->
  <div class="mode-overlay" id="modeOverlay">
    <div class="mode-dialog">
      <h1>æ²‰æµ¸å¼ç”µæ¢¯ç¾¤æ§æ¨¡æ‹Ÿå™¨ V8</h1>
      <p>è¯·é€‰æ‹©ä½ è¦ç©çš„æ¨¡å¼ï¼š</p>
      <div class="mode-buttons">
        <button class="mode-btn mode-btn-career" id="btnCareerMode" onclick="startGame('career')">
          ç”Ÿæ¶¯æ¨¡å¼ï¼ˆé‡é”¤ç»è¥ï¼‰
        </button>
        <button class="mode-btn mode-btn-free" id="btnFreeMode" onclick="startGame('free')">
          è‡ªç”±æ¨¡å¼ï¼ˆæ²™ç›’ä½“éªŒï¼‰
        </button>
      </div>
      <p class="mode-tip">
        ç”Ÿæ¶¯ï¼šæ¯æ ‹æ¥¼ç‹¬ç«‹ç”µæ¢¯ç»„ï¼Œä» 1 å°ç”µæ¢¯èµ·å®¶ï¼Œä¸èƒ½æ‰‹åŠ¨æŒ‰æŒ‰é’®ï¼Œåªèƒ½ç»è¥æ‰©å»º/ç§‘æŠ€/ç»´æŠ¤/äº‹ä»¶ã€‚<br>
        è‡ªç”±ï¼šå…¨å¼€è®¾ç½®ã€éšä¾¿æŠ˜è…¾ + å·¥å…·ç®±ï¼ˆç¼–è¾‘/ä¼ é€/å¿«è¿›ï¼‰ã€‚
      </p>
    </div>
  </div>

  <!-- æ¸¸æˆç»“æŸ -->
  <div class="mode-overlay" id="gameOverOverlay" style="display:none;">
    <div class="mode-dialog">
      <h2>ç”Ÿæ¶¯ç»“æŸ</h2>
      <p id="gameOverReason">åŸå› ï¼šèµ„é‡‘äºç©ºã€‚</p>
      <p>
        æœ€ç»ˆæ¥åˆ°ç¬¬ <span id="gameOverDay">1</span> å¤©ï¼Œ<br>
        èµ„é‡‘ <span id="gameOverMoney">0</span> å…ƒï¼Œå£ç¢‘ <span id="gameOverRep">0</span> åˆ†ã€‚
      </p>
      <div class="mode-buttons">
        <button class="mode-btn mode-btn-career" id="btnRestartCareer">é‡æ–°å¼€å§‹ç”Ÿæ¶¯</button>
        <button class="mode-btn mode-btn-free" id="btnGoMainMenu">å›åˆ°ä¸»èœå•</button>
      </div>
      <p class="mode-tip">æç¤ºï¼šè‹¥æŠ•ç¥¨è§£é›‡å€’è®¡æ—¶å½’é›¶ï¼Œä½ ä¼šç›´æ¥å‡ºå±€ã€‚</p>
    </div>
  </div>

  <div class="status-log" id="statusLog">ç¾¤æ§åˆå§‹åŒ–ä¸­...</div>

  <div class="layout">
    <!-- å·¦ä¾§ï¼šæ¥¼å±‚å‘¼æ¢¯ + æ‹¥å µçƒ­åŠ›å›¾ -->
    <div class="floor-panel" id="floorPanel">
      <div class="floor-panel-title">æ¥¼å±‚å‘¼æ¢¯ / æ‹¥å µ</div>
    </div>

    <!-- ä¸­é—´ï¼šè½¿å¢è§†è§’ -->
    <div class="elevator-shaft" id="shaft">
      <div class="interior-back">
        <div class="ad-screen">
          <div style="padding:20px; font-weight:bold; color: white;">
            <div id="adText">ä»Šæ—¥æ–°é—»ï¼š<br>ç”µæ¢¯æ–‡æ˜ä¹˜æ¢¯å®£ä¼ å‘¨å¯åŠ¨</div>
          </div>
        </div>
      </div>

      <div class="door-container open" id="doors">
        <div class="door left"></div>
        <div class="door right"></div>
      </div>

      <div class="control-panel">
        <div class="group-tabs" id="groupTabs"></div>

        <div class="display-screen">
          <span class="direction-arrow" id="arrow-up">â–²</span>
          <span class="floor-num active" id="floor-display">1</span>
          <span class="direction-arrow" id="arrow-down">â–¼</span>
          <div class="display-sub">
            <span id="displayState">IDLE</span>
            <span id="displayHint">é€‰æ‹©æ¨¡å¼å¼€å§‹æ¸¸æˆ</span>
          </div>
        </div>

        <div class="active-elevator-info">
          å½“å‰è½¿å¢ï¼š<span id="activeElevatorLabel">E1</span><br>
          ä¹˜å®¢ï¼š<span id="activeElevatorLoad">0</span>/<span id="activeElevatorCap">0</span> Â· æƒ…ç»ªï¼š<span id="activeElevatorMood">ğŸ˜Š</span>
        </div>

        <div class="button-grid" id="btn-container"></div>

        <div class="func-btn-group">
          <div class="elevator-btn func-btn" id="btnOpenDoor">&#60;|&#62;</div>
          <div class="elevator-btn func-btn" id="btnCloseDoor">&#62;|&#60;</div>
          <div class="elevator-btn func-btn" style="color:red" id="btnAlarm">ğŸ””</div>
        </div>

        <div class="info-plate">
          è½½é‡ <span id="plateLoad">1000</span>KG<br>
          å®šå‘˜ <span id="platePerson">13</span>äºº<br>
          ç¾¤æ§æ¨¡å¼ï¼šAI è°ƒåº¦<br>
          <span style="color:red; font-weight:bold">ç¦æ­¢æ‰“æ¶ Â· ç¦æ­¢å¸çƒŸ</span>
        </div>
      </div>
    </div>

    <!-- å³ä¾§ï¼šç¾¤æ§/å‰§æƒ…/æ¥¼æ ‹ -->
    <div class="group-panel" id="groupPanel">

      <div class="side-tabs">
        <div class="side-tab active" data-tab="monitor">ç›‘æ§/è®¾ç½®</div>
        <div class="side-tab" data-tab="story">å‰§æƒ…/äº‹ä»¶</div>
        <div class="side-tab" data-tab="building">æ¥¼æ ‹è§†è§’</div>
      </div>

      <!-- ç›‘æ§/è®¾ç½® -->
      <div class="side-section active" id="tab-monitor">
        <div class="group-header">ç¾¤æ§ç›‘æ§ / AI æŠ¢æ¢¯</div>

        <div class="career-panel">
          <div class="career-header">
            <span>å½“å‰æ¨¡å¼ï¼š<span class="value" id="careerModeText">æœªå¼€å§‹</span></span>
            <span id="careerModeSubText" style="font-size:10px;color:#aaa;">è¯·å…ˆé€‰æ‹©æ¨¡å¼</span>
          </div>
          <div class="career-row">
            <span>æ—¶é—´ï¼š</span>
            <span>ç¬¬ <span class="value" id="careerDay">1</span> å¤© Â· <span class="value" id="careerTime">08:00</span></span>
          </div>
          <div class="career-row"><span>èµ„é‡‘ï¼š</span><span class="value" id="careerMoney">0</span><span> å…ƒ</span></div>
          <div class="career-row">
            <span>å£ç¢‘ï¼š</span>
            <span class="value" id="careerReputation">0</span>
            <span id="careerReputationFace">ğŸ˜</span>
            <div class="career-rep-bar"><div class="career-rep-inner" id="careerReputationBar"></div></div>
          </div>
          <div class="career-row">
            <span>ç¥¨ä»·ï¼š</span>
            <div>
              <button class="career-small-btn" id="priceDown">-</button>
              <span class="value" id="careerPrice">3</span><span> å…ƒ</span>
              <button class="career-small-btn" id="priceUp">+</button>
            </div>
          </div>
          <div class="career-row">
            <span>ç»´æŠ¤ç­‰çº§ï¼š</span>
            <span class="value" id="careerMaintenance">1</span>
            <button class="career-small-btn" id="btnUpgradeMaint">å‡çº§ç»´æŠ¤</button>
          </div>

          <!-- ç”Ÿæ¶¯æ‰©å»º -->
          <div class="career-row">
            <span>æ‰©å»ºæ¥¼æ ‹ï¼š</span>
            <button class="career-small-btn" id="btnExpandBuilding">æ‰©å»º</button>
            <span id="expandBuildingCostText" style="font-size:10px;color:#aaa;"></span>
          </div>
          <div class="career-row">
            <span>å½“å‰æ¥¼æ ‹æ‰©å»ºç”µæ¢¯ï¼š</span>
            <button class="career-small-btn" id="btnExpandElevator">è´­ä¹°</button>
            <span id="expandElevatorCostText" style="font-size:10px;color:#aaa;"></span>
          </div>
          <div class="career-row">
            <span>æ‰©å»ºæ¥¼å±‚ï¼š</span>
            <button class="career-small-btn" id="btnExpandFloors">åŠ å±‚</button>
            <span id="expandFloorsCostText" style="font-size:10px;color:#aaa;"></span>
          </div>

          <div class="career-row"><span>ä»Šæ—¥æŠ•è¯‰ï¼š</span><span class="value" id="careerComplaints">0</span></div>
          <div class="career-row">
            <span>è¿½è´£æ¬¡æ•°ï¼š</span><span class="value" id="careerStrikes">0</span>
          </div>
          <div class="career-row">
            <span>è§£é›‡æŠ•ç¥¨å€’è®¡æ—¶ï¼š</span>
            <span class="value" id="careerVoteDays">-</span>
          </div>

          <!-- è¿è¥ç­–ç•¥ -->
          <div class="policy-panel">
            <div class="policy-title">è¿è¥ç­–ç•¥ï¼ˆç”Ÿæ¶¯ä¸“å±ï¼‰</div>

            <div class="policy-item">
              <div class="policy-row">
                <span>ğŸ“¢ å¼•å¯¼å‘˜/æ–‡æ˜å®£ä¼ </span>
                <button class="policy-btn" id="btnToggleGuide">å…³é—­</button>
              </div>
              <div class="policy-desc">
                æ¯æ—¥æˆæœ¬ï¼š<span class="value" id="policyGuideCost">300</span> å…ƒã€‚<br>
                æ•ˆæœï¼šé™ä½æ’é˜Ÿäº‰æ‰§ä¸è½¿å¢å†²çªæ¦‚ç‡ï¼Œä¹˜å®¢ç­‰å¾…æƒ…ç»ªä¸‹é™æ›´æ…¢ã€‚
              </div>
            </div>

            <div class="policy-item">
              <div class="policy-row">
                <span>ğŸ‘® å®‰ä¿å·¡é€»</span>
                <button class="policy-btn" id="btnToggleSecurity">å…³é—­</button>
              </div>
              <div class="policy-desc">
                æ¯æ—¥æˆæœ¬ï¼š<span class="value" id="policySecurityCost">450</span> å…ƒã€‚<br>
                æ•ˆæœï¼šæ˜¾è‘—é™ä½â€œæ¢¯æ¯â€å‡ºç°ä¸ç ´åæ¦‚ç‡ï¼Œå‡å°‘äººä¸ºæ•…éšœè´Ÿé¢ã€‚
              </div>
            </div>
          </div>

          <!-- ç§‘æŠ€æ ‘ -->
          <div class="tech-panel">
            <div style="font-weight:bold;">ç§‘æŠ€æ ‘ï¼ˆç”Ÿæ¶¯ä¸“å±ï¼‰</div>
            <div id="techList"></div>
          </div>

          <div class="career-row"><button class="career-main-btn" id="btnBackToMenu">å›åˆ°ä¸»èœå•ï¼ˆæš‚åœï¼‰</button></div>
        </div>

        <div class="elevator-list" id="elevatorList"></div>

        <div class="group-settings" id="settingsBox">
          <label>æ€»æ¥¼å±‚ï¼ˆå…¨æ¥¼ä¸€è‡´ï¼‰
            <input type="number" id="setFloors" min="3" max="30">
          </label>
          <label>å½“å‰æ¥¼æ ‹ç”µæ¢¯æ•°é‡
            <input type="number" id="setElevators" min="1" max="4">
          </label>
          <label>AI ç­–ç•¥
            <select id="setAlgo">
              <option value="ai">æ™ºèƒ½ç»¼åˆï¼ˆAI æŠ¢æ¢¯ï¼‰</option>
              <option value="nearest">æœ€è¿‘ç”µæ¢¯</option>
              <option value="random">éšæœºæŠ¢å•</option>
            </select>
          </label>
          <label>å®¢æµå¼ºåº¦ï¼ˆå…¨æ¥¼ä¸€è‡´ï¼‰
            <input type="range" id="setTraffic" min="1" max="10">
          </label>
          <div class="inline">
            <input type="checkbox" id="setFaults" checked>
            <span>å¯ç”¨éšæœºæ•…éšœ</span>
          </div>
          <div class="inline" style="color:#aaa;">
            <span id="settingsLockHint">è‡ªç”±æ¨¡å¼å¯ç›´æ¥ä¿®æ”¹è®¾ç½®</span>
          </div>
        </div>

        <!-- è‡ªç”±æ¨¡å¼å·¥å…·ç®±ï¼ˆV8 åŠ å¼ºï¼‰ -->
        <div class="free-tools" id="freeTools">
          <div class="free-tools-title">è‡ªç”±æ¨¡å¼å·¥å…·ç®± V8</div>
          <div class="free-tools-buttons">
            <button class="free-tool-btn" id="btnFreeSpawnNormal">+ ä¹˜å®¢</button>
            <button class="free-tool-btn" id="btnFreeSpawnFan">+ çˆ±å¥½è€…</button>
            <button class="free-tool-btn" id="btnFreeSpawnSab">+ æ¢¯æ¯</button>
            <button class="free-tool-btn" id="btnFreeClearFaults">æ¸…é™¤æ•…éšœ</button>
            <button class="free-tool-btn" id="btnFreeClearAll">æ¸…ç©ºç­‰å¾…</button>

            <button class="free-tool-btn" id="btnFreeTeleport">ä¼ é€å½“å‰æ¢¯</button>
            <button class="free-tool-btn" id="btnFreeEditElev">ç”µæ¢¯ç¼–è¾‘å™¨</button>
            <button class="free-tool-btn" id="btnFreeFF1h">å¿«è¿› 1 å°æ—¶</button>
            <button class="free-tool-btn" id="btnFreeFF1d">å¿«è¿› 1 å¤©</button>
          </div>
        </div>

        <div class="events-log" id="eventsLog"></div>
      </div>

      <!-- å‰§æƒ…/äº‹ä»¶ -->
      <div class="side-section" id="tab-story">
        <div class="story-panel">
          <div style="font-weight:bold;">äº‹ä»¶é˜Ÿåˆ—</div>
          <div class="story-queue" id="storyQueue"></div>

          <div style="font-weight:bold;">å½“å‰äº‹ä»¶</div>
          <div class="story-current" id="storyCurrent"></div>
        </div>
      </div>

      <!-- æ¥¼æ ‹è§†è§’ -->
      <div class="side-section" id="tab-building">
        <div class="building-panel">
          <div style="font-weight:bold;">æ¥¼æ ‹è§†è§’ï¼ˆåˆ‡æ¢ç›‘æ§/å®¢æµï¼‰</div>
          <div class="building-buttons" id="buildingButtons"></div>
          <div class="building-card" id="buildingCard"></div>
          <div class="building-tip" id="buildingTip"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  window.onerror = function(msg, url, line, col, err){
    const text = `JSæŠ¥é”™ï¼š${msg} @${line}:${col}`;
    const log = document.getElementById('statusLog');
    if (log) log.innerHTML = text;
    console.error(err);
  };

  // ================================
  //   ç¾¤æ§ç”µæ¢¯æ¨¡æ‹Ÿå™¨ V8 æœ€ç»ˆå®Œç»“ç‰ˆ
  //   V8 æ–°å¢ï¼š
  //   1) æ¢¯æ¯ä¼ªè£…ï¼ˆæœªéœ²é¦…å‰å½“æ™®é€šäººï¼‰
  //   2) æ‘„å½±å¤§èµ› Buffï¼ˆç”Ÿæ¶¯é•¿æœŸå¢ç›Šï¼‰
  //   3) è‡ªç”±æ¨¡å¼ç¼–è¾‘å™¨ / ä¼ é€ / å¿«è¿›
  // ================================

  let gameMode = null;
  let simulationRunning = false;

  const CAREER_DEFAULT = {
    day: 1,
    timeMinutes: 8 * 60,
    money: 8000,
    reputation: 75,
    ticketPrice: 3,
    maintenanceLevel: 1,
    complaints: 0,
    servedToday: 0,
    buildingsExpanded: 0,
    strikes: 0,
    voteDaysLeft: null,
    tech: { dispatch: 0, comfort: 0, reliability: 0 },
    policies: { crowdGuide:false, securityPatrol:false },
    stats: { fansServed:0, sabotageIncidents:0, fansServedToday:0 },
    buffs: { photoContestUntilDay: 0, repGainMult:1, fanSpawnMult:1, tipMult:1 }
  };
  let career = { ...CAREER_DEFAULT };

  const SETTINGS_KEY = 'immersive_elevator_group_settings_v8';
  const SETTINGS_DEFAULT = {
    floors: 8,
    algo: 'ai',
    traffic: 5,
    randomFaults: true,
    buildings: [
      { label: 'Aåº§', type: 'residential', elevatorCount: 1 }
    ],
    currentBuilding: 0
  };

  const BUILDING_TYPES = {
    residential: { name:'ä½å®…', trafficBias:'random', patienceBias:1 },
    office:      { name:'å†™å­—æ¥¼', trafficBias:'commute', patienceBias:2 },
    mall:        { name:'å•†åœº', trafficBias:'mid', patienceBias:1 },
    hospital:    { name:'åŒ»é™¢', trafficBias:'random', patienceBias:3 }
  };

  const ELEVATOR_MODELS_BASE = [
    { key:'slow', name:'æ˜Ÿç›7000 æ…¢è½¦', capacity:12, loadKg:1000, speedPerFloor:1.6, doorTime:2.2 },
    { key:'comfort', name:'AI é™éŸ³èˆ’é€‚', capacity:14, loadKg:1000, speedPerFloor:1.2, doorTime:2.0 }
  ];
  const ELEVATOR_MODELS_UNLOCK = {
    highspeed: { key:'highspeed', name:'æé€Ÿ Pro é«˜é€Ÿ', capacity:14, loadKg:1000, speedPerFloor:0.75, doorTime:1.4, need:{dispatch:3} },
    heavyload: { key:'heavyload', name:'å·¨è½½ 2000KG å¤§è½½é‡', capacity:20, loadKg:2000, speedPerFloor:1.25, doorTime:2.1, need:{comfort:3} },
    hospitalP: { key:'hospitalP', name:'æ€¥è¯Šä¼˜å…ˆ Â· åŒ»é™¢ä¸“ç”¨', capacity:16, loadKg:1200, speedPerFloor:0.95, doorTime:1.6, need:{reliability:3}, hospitalPriority:true }
  };

  let settings = loadSettings();

  let elevators = [];
  let hallCalls = [];
  let passengers = [];
  let nextPassengerId = 1;
  let nextCallId = 1;
  let activeElevatorIndex = 0;

  let spawnTimer = null;
  let moodTimer = null;
  let adTimer = null;
  let adForceUntil = 0;
  let movingCount = 0;
  let lastFightAtFloor = {};
  let lastCabinConflictAt = {};
  let lastFestivalDay = 0;
  let lastOwnerGroupDay = 0;

  let festival = null;

  let storyQueue = [];
  let nextStoryId = 1;
  let focusedStoryId = null;

  let audioCtx = null;
  let motorOsc = null;

  let statusLog, floorPanel, shaft, doors, btnContainer, groupTabs, elevatorList, eventsLog;
  let floorDisplay, arrowUp, arrowDown, adTextEl, displayState, displayHint;
  let activeElevatorLabel, activeElevatorLoad, activeElevatorCap, activeElevatorMood;
  let plateLoad, platePerson;

  let setFloors, setElevators, setAlgo, setTraffic, setFaults, settingsLockHint, settingsBox;

  let modeOverlay, gameOverOverlay;
  let btnCareerMode, btnFreeMode, btnRestartCareer, btnGoMainMenu, btnBackToMenu;

  let careerModeText, careerModeSubText, careerDay, careerTime, careerMoney, careerReputation, careerReputationFace, careerReputationBar;
  let careerPrice, careerMaintenance, careerComplaints, careerStrikesEl, careerVoteDaysEl;
  let priceUpBtn, priceDownBtn, upgradeMaintBtn, expandBuildingBtn, expandElevatorBtn, expandFloorsBtn;
  let expandBuildingCostText, expandElevatorCostText, expandFloorsCostText;
  let techListEl;

  let gameOverReason, gameOverDay, gameOverMoney, gameOverRep;

  let sideTabs;
  let storyQueueEl, storyCurrentEl;
  let buildingButtonsEl, buildingCardEl, buildingTipEl;

  let btnToggleGuide, btnToggleSecurity, policyGuideCostEl, policySecurityCostEl;

  let freeToolsEl, btnFreeSpawnNormal, btnFreeSpawnFan, btnFreeSpawnSab, btnFreeClearFaults, btnFreeClearAll;
  let btnFreeTeleport, btnFreeEditElev, btnFreeFF1h, btnFreeFF1d;

  document.addEventListener('DOMContentLoaded', () => {
    statusLog = document.getElementById('statusLog');
    floorPanel = document.getElementById('floorPanel');
    shaft = document.getElementById('shaft');
    doors = document.getElementById('doors');
    btnContainer = document.getElementById('btn-container');
    groupTabs = document.getElementById('groupTabs');
    elevatorList = document.getElementById('elevatorList');
    eventsLog = document.getElementById('eventsLog');

    floorDisplay = document.getElementById('floor-display');
    arrowUp = document.getElementById('arrow-up');
    arrowDown = document.getElementById('arrow-down');
    adTextEl = document.getElementById('adText');
    displayState = document.getElementById('displayState');
    displayHint = document.getElementById('displayHint');

    activeElevatorLabel = document.getElementById('activeElevatorLabel');
    activeElevatorLoad = document.getElementById('activeElevatorLoad');
    activeElevatorCap = document.getElementById('activeElevatorCap');
    activeElevatorMood = document.getElementById('activeElevatorMood');

    plateLoad = document.getElementById('plateLoad');
    platePerson = document.getElementById('platePerson');

    setFloors = document.getElementById('setFloors');
    setElevators = document.getElementById('setElevators');
    setAlgo = document.getElementById('setAlgo');
    setTraffic = document.getElementById('setTraffic');
    setFaults = document.getElementById('setFaults');
    settingsLockHint = document.getElementById('settingsLockHint');
    settingsBox = document.getElementById('settingsBox');

    modeOverlay = document.getElementById('modeOverlay');
    gameOverOverlay = document.getElementById('gameOverOverlay');
    btnCareerMode = document.getElementById('btnCareerMode');
    btnFreeMode = document.getElementById('btnFreeMode');
    btnRestartCareer = document.getElementById('btnRestartCareer');
    btnGoMainMenu = document.getElementById('btnGoMainMenu');
    btnBackToMenu = document.getElementById('btnBackToMenu');

    careerModeText = document.getElementById('careerModeText');
    careerModeSubText = document.getElementById('careerModeSubText');
    careerDay = document.getElementById('careerDay');
    careerTime = document.getElementById('careerTime');
    careerMoney = document.getElementById('careerMoney');
    careerReputation = document.getElementById('careerReputation');
    careerReputationFace = document.getElementById('careerReputationFace');
    careerReputationBar = document.getElementById('careerReputationBar');
    careerPrice = document.getElementById('careerPrice');
    careerMaintenance = document.getElementById('careerMaintenance');
    careerComplaints = document.getElementById('careerComplaints');
    careerStrikesEl = document.getElementById('careerStrikes');
    careerVoteDaysEl = document.getElementById('careerVoteDays');

    priceUpBtn = document.getElementById('priceUp');
    priceDownBtn = document.getElementById('priceDown');
    upgradeMaintBtn = document.getElementById('btnUpgradeMaint');
    expandBuildingBtn = document.getElementById('btnExpandBuilding');
    expandElevatorBtn = document.getElementById('btnExpandElevator');
    expandFloorsBtn = document.getElementById('btnExpandFloors');
    expandBuildingCostText = document.getElementById('expandBuildingCostText');
    expandElevatorCostText = document.getElementById('expandElevatorCostText');
    expandFloorsCostText = document.getElementById('expandFloorsCostText');
    techListEl = document.getElementById('techList');

    gameOverReason = document.getElementById('gameOverReason');
    gameOverDay = document.getElementById('gameOverDay');
    gameOverMoney = document.getElementById('gameOverMoney');
    gameOverRep = document.getElementById('gameOverRep');

    sideTabs = document.querySelectorAll('.side-tab');
    storyQueueEl = document.getElementById('storyQueue');
    storyCurrentEl = document.getElementById('storyCurrent');
    buildingButtonsEl = document.getElementById('buildingButtons');
    buildingCardEl = document.getElementById('buildingCard');
    buildingTipEl = document.getElementById('buildingTip');

    btnToggleGuide = document.getElementById('btnToggleGuide');
    btnToggleSecurity = document.getElementById('btnToggleSecurity');
    policyGuideCostEl = document.getElementById('policyGuideCost');
    policySecurityCostEl = document.getElementById('policySecurityCost');

    freeToolsEl = document.getElementById('freeTools');
    btnFreeSpawnNormal = document.getElementById('btnFreeSpawnNormal');
    btnFreeSpawnFan = document.getElementById('btnFreeSpawnFan');
    btnFreeSpawnSab = document.getElementById('btnFreeSpawnSab');
    btnFreeClearFaults = document.getElementById('btnFreeClearFaults');
    btnFreeClearAll = document.getElementById('btnFreeClearAll');

    btnFreeTeleport = document.getElementById('btnFreeTeleport');
    btnFreeEditElev = document.getElementById('btnFreeEditElev');
    btnFreeFF1h = document.getElementById('btnFreeFF1h');
    btnFreeFF1d = document.getElementById('btnFreeFF1d');

    initSideTabs();
    initSettingsUI();
    initButtons();
    initModeButtons();
    initPolicyButtons();
    initFreeTools();

    updateCareerUI();
    buildBuildingUI();
    renderTechUI();
    renderStoryUI();
    startAdLoop();
  });

  function initSideTabs(){
    sideTabs.forEach(tab=>{
      tab.addEventListener('click', ()=>{
        sideTabs.forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        const name = tab.dataset.tab;
        document.querySelectorAll('.side-section').forEach(sec=>sec.classList.remove('active'));
        document.getElementById('tab-'+name).classList.add('active');
      });
    });
  }

  function initPolicyButtons(){
    if (btnToggleGuide) btnToggleGuide.addEventListener('click', ()=>{
      if (gameMode!=='career') { logEvent('æ”¿ç­–ä»…ç”Ÿæ¶¯ç”Ÿæ•ˆã€‚','warn'); return; }
      career.policies.crowdGuide = !career.policies.crowdGuide;
      logEvent(`è¿è¥ç­–ç•¥ï¼šå¼•å¯¼å‘˜/æ–‡æ˜å®£ä¼  ${career.policies.crowdGuide?'å¼€å¯':'å…³é—­'}`,'info');
      updateCareerUI();
    });
    if (btnToggleSecurity) btnToggleSecurity.addEventListener('click', ()=>{
      if (gameMode!=='career') { logEvent('æ”¿ç­–ä»…ç”Ÿæ¶¯ç”Ÿæ•ˆã€‚','warn'); return; }
      career.policies.securityPatrol = !career.policies.securityPatrol;
      logEvent(`è¿è¥ç­–ç•¥ï¼šå®‰ä¿å·¡é€» ${career.policies.securityPatrol?'å¼€å¯':'å…³é—­'}`,'info');
      updateCareerUI();
    });
  }

  function initFreeTools(){
    if (btnFreeSpawnNormal) btnFreeSpawnNormal.addEventListener('click', ()=>spawnForcedPassenger('normal'));
    if (btnFreeSpawnFan) btnFreeSpawnFan.addEventListener('click', ()=>spawnForcedPassenger('enthusiast'));
    if (btnFreeSpawnSab) btnFreeSpawnSab.addEventListener('click', ()=>spawnForcedPassenger('saboteur'));
    if (btnFreeClearFaults) btnFreeClearFaults.addEventListener('click', ()=>{
      elevators.forEach(e=>{ if(e.fault) clearFault(e); });
      logEvent('è‡ªç”±å·¥å…·ï¼šå·²æ¸…é™¤å…¨æ¥¼æ•…éšœ','info');
    });
    if (btnFreeClearAll) btnFreeClearAll.addEventListener('click', ()=>{
      passengers.forEach(p=>p.state='gone');
      hallCalls.forEach(c=>c.served=true);
      updateHeatmap();
      updateStatusLog();
      logEvent('è‡ªç”±å·¥å…·ï¼šå·²æ¸…ç©ºç­‰å¾…/å‘¼æ¢¯/ä¹˜å®¢','info');
    });

    // V8 æ–°å¢è‡ªç”±åŠŸèƒ½
    if (btnFreeTeleport) btnFreeTeleport.addEventListener('click', freeTeleportActiveElevator);
    if (btnFreeEditElev) btnFreeEditElev.addEventListener('click', freeEditActiveElevator);
    if (btnFreeFF1h) btnFreeFF1h.addEventListener('click', ()=>freeFastForward(60));
    if (btnFreeFF1d) btnFreeFF1d.addEventListener('click', ()=>freeFastForward(24*60));
  }

  function freeTeleportActiveElevator(){
    if (gameMode!=='free' || !simulationRunning){ logEvent('ä»…è‡ªç”±æ¨¡å¼è¿è¡Œä¸­å¯ç”¨ã€‚','warn'); return; }
    const e = elevators.find(x=>x.id===activeElevatorIndex);
    if (!e) return;
    const val = prompt(`ä¼ é€ ${e.name} åˆ°å‡ å±‚ï¼Ÿ(1-${settings.floors})`, e.currentFloor);
    if (val==null) return;
    const f = clamp(parseInt(val,10)||e.currentFloor,1,settings.floors);
    clearInterval(e.moveTimer); e.moveTimer=null;
    e.currentFloor=f; e.state='IDLE'; e.direction=0; e.doorOpen=true; e.stops=[];
    movingCount=0; updateMotorSound(); shaft.classList.remove('shaking');
    logEvent(`è‡ªç”±ä¼ é€ï¼š${e.name} -> ${f}F`,'info');
    syncActiveUI();
  }

  function freeEditActiveElevator(){
    if (gameMode!=='free' || !simulationRunning){ logEvent('ä»…è‡ªç”±æ¨¡å¼è¿è¡Œä¸­å¯ç”¨ã€‚','warn'); return; }
    const e = elevators.find(x=>x.id===activeElevatorIndex);
    if (!e) return;
    const cap = prompt(`ç¼–è¾‘å®¹é‡ capacityï¼ˆå½“å‰ ${e.capacity}ï¼‰`, e.capacity);
    if (cap==null) return;
    const spd = prompt(`ç¼–è¾‘é€Ÿåº¦ speedPerFloor ç§’/å±‚ï¼ˆå½“å‰ ${e.speedPerFloor}ï¼‰`, e.speedPerFloor);
    if (spd==null) return;
    const door = prompt(`ç¼–è¾‘å¼€å…³é—¨ doorTime ç§’ï¼ˆå½“å‰ ${e.doorTime}ï¼‰`, e.doorTime);
    if (door==null) return;

    e.capacity = clamp(parseInt(cap,10)||e.capacity, 4, 50);
    e.speedPerFloor = clamp(parseFloat(spd)||e.speedPerFloor, 0.3, 4);
    e.doorTime = clamp(parseFloat(door)||e.doorTime, 0.6, 5);

    logEvent(`è‡ªç”±ç¼–è¾‘ï¼š${e.name} å‚æ•°å·²æ›´æ–°ï¼ˆcap=${e.capacity}, speed=${e.speedPerFloor}, door=${e.doorTime}ï¼‰`,'info');
    syncActiveUI();
    updateElevatorCards();
  }

  function freeFastForward(mins){
    if (gameMode!=='free' || !simulationRunning){ logEvent('ä»…è‡ªç”±æ¨¡å¼è¿è¡Œä¸­å¯ç”¨ã€‚','warn'); return; }
    career.timeMinutes += mins;
    // è‡ªç”±æ¨¡å¼ä¸ç»“ç®—è¾“èµ¢ï¼Œä½†ä¼šè®©ä½ çœ‹åˆ°æ—¶é—´å˜åŒ–
    logEvent(`è‡ªç”±å¿«è¿›ï¼š+${mins} åˆ†é’Ÿï¼ˆå½“å‰ ${formatTime(career.timeMinutes)}ï¼‰`,'info');
    updateCareerUI();
  }

  function spawnForcedPassenger(trait){
    if (!simulationRunning || gameMode!=='free') { logEvent('ä»…è‡ªç”±æ¨¡å¼è¿è¡Œä¸­å¯ç”¨ã€‚','warn'); return; }
    const bidx = settings.currentBuilding;
    const b = settings.buildings[bidx];
    const bias = BUILDING_TYPES[b.type];

    let from, to;
    if (bias.trafficBias === 'commute') {
      from = randomInt(1, Math.min(3, settings.floors));
      to = randomInt(Math.ceil(settings.floors*0.6), settings.floors);
    } else if (bias.trafficBias === 'mid') {
      from = randomInt(Math.floor(settings.floors*0.3), Math.floor(settings.floors*0.7));
      to = randomInt(1, settings.floors);
    } else {
      from = randomInt(1, settings.floors);
      to = randomInt(1, settings.floors);
    }
    if (to === from) to = from === settings.floors ? from - 1 : from + 1;

    const p = makePassenger(from,to,bidx,trait);
    passengers.push(p);
    hallCall(from, to>from?'up':'down', p);
    logEvent(`è‡ªç”±åˆ·å®¢ï¼šP${p.id}ï¼ˆ${traitLabelVisible(p)}ï¼‰ ${from}F â†’ ${to}F`,'info');
    updateHeatmap();
  }

  function initModeButtons() {
    if (btnCareerMode) btnCareerMode.addEventListener('click', () => startGame('career'));
    if (btnFreeMode) btnFreeMode.addEventListener('click', () => startGame('free'));

    if (btnRestartCareer) btnRestartCareer.addEventListener('click', () => {
      gameOverOverlay.style.display = 'none';
      startGame('career');
    });

    if (btnGoMainMenu) btnGoMainMenu.addEventListener('click', () => {
      gameOverOverlay.style.display = 'none';
      simulationRunning = false;
      gameMode = null;
      if (spawnTimer) clearInterval(spawnTimer);
      if (moodTimer) clearInterval(moodTimer);
      displayHint.innerText = 'è¿”å›ä¸»èœå•ï¼Œè¯·é‡æ–°é€‰æ‹©æ¨¡å¼';
      modeOverlay.style.display = 'flex';
      updateCareerUI();
      updateSettingsLock();
    });

    if (btnBackToMenu) btnBackToMenu.addEventListener('click', () => {
      simulationRunning = false;
      if (spawnTimer) clearInterval(spawnTimer);
      if (moodTimer) clearInterval(moodTimer);
      displayHint.innerText = 'å·²æš‚åœï¼Œå›åˆ°ä¸»èœå•';
      modeOverlay.style.display = 'flex';
      logEvent('ä½ è¿”å›äº†ä¸»èœå•ï¼Œå¯ä»¥é‡æ–°é€‰æ‹©æ¨¡å¼å¼€å§‹æ–°çš„è¿è¡Œã€‚', 'info');
    });

    if (priceUpBtn) priceUpBtn.addEventListener('click', () => {
      career.ticketPrice = Math.min(10, career.ticketPrice + 0.5);
      logEvent(`ç¥¨ä»·è°ƒæ•´ä¸º ${career.ticketPrice.toFixed(1)} å…ƒ`, 'info');
      updateCareerUI();
    });

    if (priceDownBtn) priceDownBtn.addEventListener('click', () => {
      career.ticketPrice = Math.max(0, career.ticketPrice - 0.5);
      logEvent(`ç¥¨ä»·è°ƒæ•´ä¸º ${career.ticketPrice.toFixed(1)} å…ƒ`, 'info');
      updateCareerUI();
    });

    if (upgradeMaintBtn) upgradeMaintBtn.addEventListener('click', () => {
      if (gameMode !== 'career') {
        logEvent('å½“å‰ä¸ºè‡ªç”±æ¨¡å¼ï¼Œç»´æŠ¤å‡çº§åªåšæ¼”ç¤ºæ•ˆæœã€‚', 'warn');
        career.maintenanceLevel = Math.min(5, career.maintenanceLevel + 1);
        updateCareerUI();
        return;
      }
      const cost = 1800 * career.maintenanceLevel;
      if (career.money < cost) {
        logEvent(`èµ„é‡‘ä¸è¶³ï¼Œå‡çº§ç»´æŠ¤éœ€è¦ ${cost} å…ƒã€‚`, 'warn');
        return;
      }
      career.money -= cost;
      career.maintenanceLevel = Math.min(5, career.maintenanceLevel + 1);
      logEvent(`ä½ èŠ±è´¹ ${cost} å…ƒï¼Œå°†ç»´æŠ¤ç­‰çº§æå‡åˆ° Lv.${career.maintenanceLevel}ã€‚`, 'info');
      updateCareerUI();
    });

    if (expandBuildingBtn) expandBuildingBtn.addEventListener('click', () => {
      if (gameMode !== 'career') {
        logEvent('è‡ªç”±æ¨¡å¼å¯ç›´æ¥æ”¹æ¥¼æ ‹æ•°é‡ä¸ç±»å‹ï¼Œè¿™ä¸ªæŒ‰é’®åªç»™ç”Ÿæ¶¯ç”¨ã€‚', 'warn');
        return;
      }
      const cost = getBuildingExpansionCost();
      if (career.money < cost) {
        logEvent(`æ‰©å»ºå¤±è´¥ï¼šéœ€è¦ ${cost} å…ƒã€‚`, 'warn');
        return;
      }
      career.money -= cost;

      const label = String.fromCharCode(65 + settings.buildings.length) + 'åº§';
      const types = Object.keys(BUILDING_TYPES);
      const type = types[Math.floor(Math.random()*types.length)];
      settings.buildings.push({ label, type, elevatorCount: 1 });
      career.buildingsExpanded += 1;
      settings.currentBuilding = settings.buildings.length - 1;
      saveSettings();
      buildBuildingUI();

      logEvent(`ä½ èŠ±è´¹ ${cost} å…ƒæ‰©å»ºäº† ${label}ï¼ˆç±»å‹ï¼š${BUILDING_TYPES[type].name}ï¼‰ï¼Œå¹¶é…äº† 1 å°æ–°ç”µæ¢¯ã€‚`, 'info');
      updateCareerUI();
      initSystem();
    });

    if (expandElevatorBtn) expandElevatorBtn.addEventListener('click', () => {
      if (gameMode !== 'career') { logEvent('è‡ªç”±æ¨¡å¼è¯·ç›´æ¥æ”¹è®¾ç½®ã€‚', 'warn'); return; }
      const b = currentBuilding();
      if (b.elevatorCount >= 4) { logEvent('å½“å‰æ¥¼æ ‹ç”µæ¢¯å·²è¾¾ä¸Šé™ï¼ˆ4 å°ï¼‰ã€‚', 'warn'); return; }
      const cost = getElevatorExpansionCost();
      if (career.money < cost) { logEvent(`èµ„é‡‘ä¸è¶³ï¼Œè´­ä¹°æ–°ç”µæ¢¯éœ€è¦ ${cost} å…ƒã€‚`, 'warn'); return; }
      career.money -= cost;
      b.elevatorCount += 1;
      saveSettings();
      logEvent(`ä½ ç»™ ${b.label} è´­ä¹°äº† 1 å°æ–°ç”µæ¢¯ï¼ˆèŠ±è´¹ ${cost} å…ƒï¼‰ã€‚ç°åœ¨ ${b.label} å…±æœ‰ ${b.elevatorCount} å°ã€‚`, 'info');
      updateCareerUI();
      initSystem();
    });

    if (expandFloorsBtn) expandFloorsBtn.addEventListener('click', () => {
      if (gameMode !== 'career') { logEvent('è‡ªç”±æ¨¡å¼è¯·ç›´æ¥æ”¹è®¾ç½®ã€‚', 'warn'); return; }
      if (settings.floors >= 30) { logEvent('æ¥¼å±‚å·²è¾¾ä¸Šé™ï¼ˆ30 å±‚ï¼‰ã€‚', 'warn'); return; }
      const cost = getFloorsExpansionCost();
      if (career.money < cost) { logEvent(`èµ„é‡‘ä¸è¶³ï¼ŒåŠ æ¥¼å±‚éœ€è¦ ${cost} å…ƒã€‚`, 'warn'); return; }
      career.money -= cost;
      settings.floors += 2;
      if (settings.floors > 30) settings.floors = 30;
      saveSettings();
      logEvent(`ä½ æ‰©å»ºäº†æ¥¼å±‚ï¼ˆèŠ±è´¹ ${cost} å…ƒï¼‰ã€‚ç°åœ¨æ€»æ¥¼å±‚ ${settings.floors}ã€‚`, 'info');
      updateCareerUI();
      initSystem();
    });
  }

  function startGame(mode) {
    gameMode = mode;
    simulationRunning = true;
    career = { ...CAREER_DEFAULT };
    storyQueue = []; focusedStoryId = null; nextStoryId = 1;
    lastFestivalDay = 0; lastOwnerGroupDay = 0; festival = null;

    if (mode === 'career') {
      settings.floors = 8;
      settings.randomFaults = true;
      settings.algo = 'ai';
      settings.traffic = 5;
      settings.buildings = [{ label:'Aåº§', type:'residential', elevatorCount: 1 }];
      settings.currentBuilding = 0;
      saveSettings();
    }

    modeOverlay.style.display = 'none';
    displayHint.innerText = mode === 'career'
      ? 'ç”Ÿæ¶¯æ¨¡å¼ï¼šå„æ¥¼æ ‹ç‹¬ç«‹è¿è¥ï¼Œä½ åªç®¡ç»è¥ã€‚'
      : 'è‡ªç”±æ¨¡å¼ï¼šéšä¾¿ç©ï¼Œçº¯ä½“éªŒï¼ˆè®¾ç½®å…¨å¼€ + å·¥å…·ç®±ï¼‰ã€‚';

    logEvent(mode === 'career'
      ? 'ç”Ÿæ¶¯æ¨¡å¼å¼€å§‹ï¼šä» Aåº§ 1 å°ç”µæ¢¯èµ·å®¶ã€‚ä½ ä¸èƒ½æ‰‹åŠ¨æŒ‰æŒ‰é’®ã€‚'
      : 'è‡ªç”±æ¨¡å¼å¼€å§‹ï¼Œå°½æƒ…æŠ˜è…¾è¿™äº›ç”µæ¢¯å§ã€‚', 'info');

    updateSettingsLock();
    initSystem();
    updateCareerUI();
    renderTechUI();
    renderStoryUI();
  }

  function dailySettlement() {
    if (gameMode !== 'career') {
      career.day += 1;
    } else {
      const totalElev = settings.buildings.reduce((s,b)=>s+b.elevatorCount,0);

      const policyCost =
        (career.policies.crowdGuide ? 300 : 0) +
        (career.policies.securityPatrol ? 450 : 0);

      const baseCost = 250 + totalElev * 120 + career.maintenanceLevel * 150 + career.complaints * 40 + settings.buildings.length * 180;
      career.money -= (baseCost + policyCost);

      let repBonus = 0;
      if (career.reputation >= 85) repBonus = 400;
      else if (career.reputation >= 65) repBonus = 150;
      else if (career.reputation <= 30) repBonus = -250;
      career.money += repBonus;

      if (career.voteDaysLeft != null) {
        career.voteDaysLeft -= 1;
        if (career.voteDaysLeft <= 0) {
          if (career.reputation < 55 || career.strikes >= 2) {
            checkGameOver('ä¸šä¸»æŠ•ç¥¨é€šè¿‡ï¼Œä½ è¢«è§£é›‡ã€‚');
          } else {
            logEvent('æŠ•ç¥¨æœªé€šè¿‡ï¼Œä½ ä¾¥å¹¸ç»­å‘½ï¼Œä½†ä¸šä¸»ä»åœ¨ç›¯ç€ä½ ã€‚','warn');
            career.voteDaysLeft = null;
          }
        }
      }

      logEvent(
        `ç¬¬ ${career.day} å¤©ç»“ç®—ï¼šè¿é€ ${career.servedToday} äººï¼Œæˆæœ¬ ${baseCost} å…ƒ + æ”¿ç­– ${policyCost} å…ƒï¼Œå£ç¢‘ä¿®æ­£ ${repBonus>=0?'+':''}${repBonus} å…ƒã€‚`,
        repBonus >= 0 ? 'info' : 'warn'
      );

      career.day += 1;
      career.servedToday = 0;
      career.stats.fansServedToday = 0;
      career.complaints = 0;

      // Buff è¿‡æœŸæ£€æŸ¥
      if (career.buffs.photoContestUntilDay < career.day) {
        career.buffs.repGainMult = 1;
        career.buffs.fanSpawnMult = 1;
        career.buffs.tipMult = 1;
      }

      checkGameOver();
    }

    career.timeMinutes = 8 * 60;
    updateCareerUI();
    renderTechUI();
  }

  function checkGameOver(reason) {
    if (gameMode !== 'career') return;
    if (!simulationRunning) return;

    let finalReason = reason;
    if (career.money < -2500) {
      finalReason = finalReason || 'èµ„é‡‘é•¿æœŸäºæŸï¼Œç‰©ä¸šå®£å¸ƒç ´äº§ã€‚';
    } else if (career.reputation <= 5) {
      finalReason = finalReason || 'å£ç¢‘å½»åº•å´©ç›˜ï¼Œä¸šå§”ä¼šå½“åœºå¼€é™¤ä½ ã€‚';
    } else {
      return;
    }

    simulationRunning = false;
    if (spawnTimer) clearInterval(spawnTimer);
    if (moodTimer) clearInterval(moodTimer);

    gameOverReason.textContent = finalReason;
    gameOverDay.textContent = career.day;
    gameOverMoney.textContent = Math.round(career.money);
    gameOverRep.textContent = Math.round(career.reputation);
    gameOverOverlay.style.display = 'flex';

    logEvent(`ç”Ÿæ¶¯ç»“æŸï¼š${finalReason}`, 'error');
  }

  function updateCareerUI() {
    if (!careerModeText) return;

    if (!gameMode) {
      careerModeText.textContent = 'æœªå¼€å§‹';
      careerModeSubText.textContent = 'è¯·åœ¨ä¸Šæ–¹é€‰æ‹©æ¨¡å¼';
    } else if (gameMode === 'career') {
      careerModeText.textContent = 'ç”Ÿæ¶¯æ¨¡å¼';
      let buffHint = '';
      if (career.buffs.photoContestUntilDay >= career.day) {
        buffHint = `ï½œğŸ“¸ æ‘„å½±å¤§èµ›çƒ­åº¦ä¸­+ï¼ˆå‰© ${career.buffs.photoContestUntilDay - career.day + 1} å¤©ï¼‰`;
      }
      careerModeSubText.textContent = `èµ·å®¶ç¬¬ ${career.day} å¤©ï½œä¸èƒ½æ‰‹åŠ¨æŒ‰æŒ‰é’®${buffHint}`;
    } else {
      careerModeText.textContent = 'è‡ªç”±æ¨¡å¼';
      careerModeSubText.textContent = 'è®¾ç½®å…¨å¼€ï½œä¸ç»“ç®—è¾“èµ¢';
    }

    careerDay.textContent = career.day;
    careerTime.textContent = formatTime(career.timeMinutes);
    careerMoney.textContent = Math.round(career.money);
    careerReputation.textContent = Math.round(career.reputation);
    careerPrice.textContent = career.ticketPrice.toFixed(1).replace(/\.0$/, '');
    careerMaintenance.textContent = career.maintenanceLevel;
    careerComplaints.textContent = career.complaints;
    careerStrikesEl.textContent = career.strikes;
    careerVoteDaysEl.textContent = (career.voteDaysLeft==null) ? '-' : `${career.voteDaysLeft} å¤©`;

    let face = 'ğŸ˜';
    if (career.reputation >= 80) face = 'ğŸ˜„';
    else if (career.reputation <= 30) face = 'ğŸ˜¡';
    careerReputationFace.textContent = face;
    careerReputationBar.style.width = clamp(career.reputation, 0, 100) + '%';

    const careerOnly = gameMode === 'career';
    expandBuildingBtn.disabled = !careerOnly;
    expandElevatorBtn.disabled = !careerOnly;
    expandFloorsBtn.disabled = !careerOnly;
    [expandBuildingBtn, expandElevatorBtn, expandFloorsBtn].forEach(b=>{
      b.style.opacity = b.disabled ? 0.4 : 1;
    });

    expandBuildingCostText.textContent = careerOnly ? `ä»Šæ—¥ä»·æ ¼ï¼š${getBuildingExpansionCost()} å…ƒ` : '';
    expandElevatorCostText.textContent = careerOnly ? `å½“å‰ä»·æ ¼ï¼š${getElevatorExpansionCost()} å…ƒ` : '';
    expandFloorsCostText.textContent   = careerOnly ? `å½“å‰ä»·æ ¼ï¼š${getFloorsExpansionCost()} å…ƒ` : '';

    if (btnToggleGuide){
      btnToggleGuide.textContent = career.policies.crowdGuide ? 'å¼€å¯' : 'å…³é—­';
      btnToggleGuide.classList.toggle('on', career.policies.crowdGuide);
      btnToggleGuide.classList.toggle('disabled', !careerOnly);
    }
    if (btnToggleSecurity){
      btnToggleSecurity.textContent = career.policies.securityPatrol ? 'å¼€å¯' : 'å…³é—­';
      btnToggleSecurity.classList.toggle('on', career.policies.securityPatrol);
      btnToggleSecurity.classList.toggle('disabled', !careerOnly);
    }
    if (policyGuideCostEl) policyGuideCostEl.textContent = 300;
    if (policySecurityCostEl) policySecurityCostEl.textContent = 450;

    if (freeToolsEl){
      freeToolsEl.style.display = (gameMode==='free') ? 'flex' : 'none';
    }
  }

  function initButtons() {
    document.getElementById('btnOpenDoor').addEventListener('click', () => { ensureAudio(); cabinOpenDoor(); });
    document.getElementById('btnCloseDoor').addEventListener('click', () => { ensureAudio(); cabinCloseDoor(); });
    document.getElementById('btnAlarm').addEventListener('click', () => {
      ensureAudio();
      playAlarm();
      adTextEl.innerHTML = "<span style='color:red'>è­¦å‘Šï¼š<br>è­¦é“ƒå·²è§¦å‘ï¼Œè°ƒåº¦å·²æ¥è­¦</span>";
      adForceUntil = Date.now() + 6000;
      logEvent("ä¹˜å®¢æŒ‰ä¸‹è½¿å¢è­¦é“ƒ", 'warn');
      maybeGlobalSay("è°å•ŠæŒ‰è­¦é“ƒï¼", 0.25);

      if (gameMode === 'career') {
        career.reputation = Math.max(0, career.reputation - 2);
        career.complaints += 1;
        updateCareerUI();
      }
    });
  }

  function initSettingsUI() {
    setFloors.value = settings.floors;
    setAlgo.value = settings.algo;
    setTraffic.value = settings.traffic;
    setFaults.checked = settings.randomFaults;
    setElevators.value = currentBuilding().elevatorCount;

    setFloors.addEventListener('change', () => {
      if (gameMode === 'career') return;
      settings.floors = clamp(parseInt(setFloors.value, 10) || SETTINGS_DEFAULT.floors, 3, 30);
      setFloors.value = settings.floors;
      saveSettings();
      if (simulationRunning) initSystem();
    });

    setElevators.addEventListener('change', () => {
      if (gameMode === 'career') return;
      const b = currentBuilding();
      b.elevatorCount = clamp(parseInt(setElevators.value, 10) || 1, 1, 4);
      setElevators.value = b.elevatorCount;
      saveSettings();
      if (simulationRunning) initSystem();
    });

    setAlgo.addEventListener('change', () => {
      if (gameMode === 'career') return;
      settings.algo = setAlgo.value;
      saveSettings();
      updateStatusLog();
    });

    setTraffic.addEventListener('input', () => {
      if (gameMode === 'career') return;
      settings.traffic = clamp(parseInt(setTraffic.value, 10) || 5, 1, 10);
      saveSettings();
      if (simulationRunning) restartSpawnTimer();
    });

    setFaults.addEventListener('change', () => {
      if (gameMode === 'career') return;
      settings.randomFaults = !!setFaults.checked;
      saveSettings();
    });
  }

  function updateSettingsLock(){
    const locked = gameMode === 'career';
    setFloors.disabled = locked;
    setElevators.disabled = locked;
    setFaults.disabled = locked;
    setAlgo.disabled = locked;
    setTraffic.disabled = locked;
    settingsBox.classList.toggle('lock-all', locked);

    settingsLockHint.textContent = locked
      ? 'ç”Ÿæ¶¯æ¨¡å¼ï¼šè®¾ç½®å…¨é”ï¼Œåªèƒ½é æ‰©å»º/ç§‘æŠ€/ç»´æŠ¤æ¨è¿›'
      : 'è‡ªç”±æ¨¡å¼ï¼šè®¾ç½®å…¨å¼€ + å·¥å…·ç®±';
  }

  function initSystem() {
    elevators.forEach(e => {
      clearInterval(e.moveTimer);
      clearTimeout(e.doorTimer);
      clearTimeout(e.autoCloseTimer);
    });
    if (spawnTimer) clearInterval(spawnTimer);
    if (moodTimer) clearInterval(moodTimer);

    elevators = [];
    hallCalls = [];
    passengers = [];
    lastFightAtFloor = {};
    lastCabinConflictAt = {};
    nextPassengerId = 1;
    nextCallId = 1;
    movingCount = 0;

    let eid = 0;
    settings.buildings.forEach((b, bidx)=>{
      const models = getAvailableModelsForBuilding(b.type);
      for (let i = 0; i < b.elevatorCount; i++) {
        const model = pickModelForBuilding(models, b.type);
        elevators.push({
          id: eid++,
          building: bidx,
          modelKey: model.key,
          name: `${b.label}Â·E${i+1}ï½œ${model.name}`,
          capacity: model.capacity + career.tech.comfort * 1,
          maxLoadKg: model.loadKg,
          speedPerFloor: Math.max(0.6, model.speedPerFloor - career.tech.dispatch * 0.05),
          doorTime: Math.max(1.1, model.doorTime - career.tech.dispatch * 0.05),
          hospitalPriority: !!model.hospitalPriority,
          currentFloor: 1,
          state: 'IDLE',
          direction: 0,
          doorOpen: true,
          stops: [],
          people: [],
          moveTimer: null,
          doorTimer: null,
          autoCloseTimer: null,
          fault: null
        });
      }
    });

    const curE = elevators.filter(e=>e.building===settings.currentBuilding);
    activeElevatorIndex = curE.length ? curE[0].id : 0;

    buildFloors();
    buildCabinButtons();
    buildGroupTabs();
    buildElevatorCards();

    if (simulationRunning) {
      restartSpawnTimer();
      moodTimer = setInterval(simTick, 1000);
    }

    syncActiveUI();
    updateHeatmap();
    updateStatusLog();

    const b = currentBuilding();
    logEvent(`ç³»ç»Ÿåˆå§‹åŒ–ï¼š${settings.floors} å±‚ï½œ${settings.buildings.length} æ ‹ï¼ˆå½“å‰ï¼š${b.label}Â·${BUILDING_TYPES[b.type].name}ï¼‰`, 'info');

    applyCareerButtonLock();
    renderTechUI();
  }

  function buildFloors() {
    floorPanel.innerHTML = '<div class="floor-panel-title">æ¥¼å±‚å‘¼æ¢¯ / æ‹¥å µ</div>';
    for (let f = settings.floors; f >= 1; f--) {
      const row = document.createElement('div');
      row.className = 'floor-row';
      row.dataset.floor = f;

      const label = document.createElement('div');
      label.className = 'floor-label';
      label.textContent = f;

      const btnUp = document.createElement('div');
      btnUp.className = 'hall-btn up';
      btnUp.textContent = 'â†‘';
      if (f === settings.floors) btnUp.classList.add('disabled');
      else btnUp.addEventListener('click', () => hallCall(f, 'up'));

      const btnDown = document.createElement('div');
      btnDown.className = 'hall-btn down';
      btnDown.textContent = 'â†“';
      if (f === 1) btnDown.classList.add('disabled');
      else btnDown.addEventListener('click', () => hallCall(f, 'down'));

      const heatbar = document.createElement('div');
      heatbar.className = 'heatbar';
      const inner = document.createElement('div');
      inner.className = 'heatbar-inner';
      inner.id = `heat-${f}`;
      heatbar.appendChild(inner);

      const mood = document.createElement('div');
      mood.className = 'mood-icon';
      mood.id = `mood-${f}`;

      row.appendChild(label);
      row.appendChild(btnUp);
      row.appendChild(btnDown);
      row.appendChild(heatbar);
      row.appendChild(mood);
      floorPanel.appendChild(row);
    }
  }

  function buildCabinButtons() {
    btnContainer.innerHTML = '';
    for (let f = 1; f <= settings.floors; f++) {
      const btn = document.createElement('div');
      btn.className = 'elevator-btn';
      btn.innerText = f;
      btn.id = `cab-btn-${f}`;
      btn.addEventListener('click', () => cabinPressFloor(f));
      btnContainer.appendChild(btn);
      if (f === 1) btn.style.gridColumn = '1 / span 2';
    }
  }

  function applyCareerButtonLock(){
    const lock = gameMode === 'career';
    for (let f=1; f<=settings.floors; f++){
      const b = document.getElementById(`cab-btn-${f}`);
      if (b) b.classList.toggle('disabled-btn', lock);
    }
    document.querySelectorAll('.hall-btn.up, .hall-btn.down').forEach(btn=>{
      btn.classList.toggle('disabled-btn', lock);
    });
  }

  function buildGroupTabs() {
    groupTabs.innerHTML = '';
    const curEs = elevators.filter(e=>e.building===settings.currentBuilding);
    curEs.forEach((e) => {
      const tab = document.createElement('div');
      tab.className = 'elevator-tab';
      tab.textContent = `E${e.name.split('Â·E')[1].split('ï½œ')[0]}`;
      if (e.id === activeElevatorIndex) tab.classList.add('active');
      tab.title = e.name;
      tab.addEventListener('click', () => {
        activeElevatorIndex = e.id;
        syncActiveUI();
        updateElevatorCards();
      });
      groupTabs.appendChild(tab);
    });
  }

  function buildElevatorCards() {
    elevatorList.innerHTML = '';
    const curEs = elevators.filter(e=>e.building===settings.currentBuilding);
    curEs.forEach(e => {
      const card = document.createElement('div');
      card.className = 'elevator-card';
      card.dataset.id = e.id;

      const title = document.createElement('div');
      title.className = 'elevator-card-title';
      title.textContent = e.name;

      const body = document.createElement('div');
      body.className = 'elevator-card-body';
      const left = document.createElement('div');
      left.textContent = `F${e.currentFloor} ${stateToLabel(e.state)}`;
      const right = document.createElement('div');
      right.textContent = `è½½å®¢ ${e.people.length}/${e.capacity}`;
      body.appendChild(left); body.appendChild(right);

      card.appendChild(title); card.appendChild(body);

      card.addEventListener('click', () => {
        activeElevatorIndex = e.id;
        syncActiveUI();
        updateElevatorCards();
      });

      card.addEventListener('dblclick', () => {
        const elevator = elevators.find(x=>x.id===e.id);
        if (elevator && elevator.fault) clearFault(elevator);
      });

      elevatorList.appendChild(card);
    });
    updateElevatorCards();
  }

  function updateElevatorCards() {
    const cards = elevatorList.querySelectorAll('.elevator-card');
    cards.forEach(card => {
      const id = parseInt(card.dataset.id, 10);
      const e = elevators.find(x=>x.id===id);
      if (!e) return;
      const body = card.querySelector('.elevator-card-body');
      const [left, right] = body.children;
      left.textContent = `F${e.currentFloor} ${stateToLabel(e.state)}`;
      right.textContent = `è½½å®¢ ${e.people.length}/${e.capacity}`;
      card.classList.toggle('active', id === activeElevatorIndex);
    });
  }

  function syncActiveUI() {
    const e = elevators.find(x=>x.id===activeElevatorIndex);
    if (!e) return;

    floorDisplay.innerText = e.currentFloor;
    floorDisplay.classList.add('active');
    arrowUp.classList.toggle('active', e.state === 'MOVING_UP');
    arrowDown.classList.toggle('active', e.state === 'MOVING_DOWN');
    doors.classList.toggle('open', e.doorOpen);

    activeElevatorLabel.innerText = e.name;
    activeElevatorLoad.innerText = e.people.length;
    activeElevatorCap.innerText = e.capacity;
    plateLoad.innerText = e.maxLoadKg;
    platePerson.innerText = e.capacity;

    displayState.innerText = e.state;

    for (let f = 1; f <= settings.floors; f++) {
      const btn = document.getElementById(`cab-btn-${f}`);
      if (!btn) continue;
      const pressed =
        e.stops.includes(f) ||
        e.people.some(pid => {
          const p = passengers.find(pp => pp.id === pid);
          return p && p.to === f;
        });
      btn.classList.toggle('pressed', pressed);
    }

    let mood = 100;
    const onboard = e.people.map(pid => passengers.find(pp => pp.id === pid)).filter(Boolean);
    if (onboard.length) mood = onboard.reduce((s, p) => s + p.mood, 0) / onboard.length;
    activeElevatorMood.innerText = mood >= 70 ? 'ğŸ˜„' : mood >= 40 ? 'ğŸ˜' : 'ğŸ˜¡';

    buildGroupTabs();
  }

  function syncActiveIf(e) {
    if (activeElevatorIndex === e.id) syncActiveUI();
    updateElevatorCards();
    updateStatusLog();
  }

  function cabinOpenDoor() { const e = elevators.find(x=>x.id===activeElevatorIndex); if (e) openDoor(e); }
  function cabinCloseDoor() { const e = elevators.find(x=>x.id===activeElevatorIndex); if (e) closeDoor(e, true); }

  function cabinPressFloor(floor) {
    if (gameMode === 'career') {
      logEvent('ç”Ÿæ¶¯æ¨¡å¼ï¼šä½ ä¸èƒ½æ‰‹åŠ¨æŒ‰è½¿å¢æŒ‰é’®ã€‚', 'warn');
      return;
    }
    const e = elevators.find(x=>x.id===activeElevatorIndex);
    if (!e) return;
    if (floor === e.currentFloor && e.doorOpen) return;
    addStop(e, floor, 'internal');
    syncActiveUI();
  }

  function hallCall(floor, dir, passenger) {
    if (gameMode === 'career' && !passenger) {
      logEvent('ç”Ÿæ¶¯æ¨¡å¼ï¼šä½ ä¸èƒ½æ‰‹åŠ¨å‘¼æ¢¯ï¼ŒAI å…¨æƒè°ƒåº¦ã€‚', 'warn');
      return;
    }
    const bidx = passenger ? passenger.building : settings.currentBuilding;

    let call = hallCalls.find(c => c.building===bidx && c.floor === floor && c.dir === dir && !c.served);
    if (!call) {
      call = { id: nextCallId++, building:bidx, floor, dir, assigned: null, served: false, passengerIds: [] };
      hallCalls.push(call);
    }
    if (passenger) call.passengerIds.push(passenger.id);

    if (bidx===settings.currentBuilding) {
      const btn = document.querySelector(`.floor-row[data-floor="${floor}"] .hall-btn.${dir}`);
      if (btn) btn.classList.add('active');
    }

    assignCall(call);
  }

  function assignCall(call) {
    if (call.assigned != null) return;

    const candidates = elevators.filter(e => e.building===call.building && !e.fault);
    if (!candidates.length) return;

    let chosen = null;
    if (settings.algo === 'random') {
      chosen = candidates[Math.floor(Math.random() * candidates.length)];
    } else {
      let bestScore = Infinity;
      const dirSign = call.dir === 'up' ? 1 : -1;
      candidates.forEach(e => {
        let score = Math.abs(e.currentFloor - call.floor);
        if (e.state === 'IDLE') score -= 1;
        if (e.state === 'MOVING_UP' || e.state === 'MOVING_DOWN') {
          if (e.direction !== dirSign) score += 4;
          if (e.direction === dirSign) {
            if (dirSign === 1 && call.floor < e.currentFloor) score += 2;
            if (dirSign === -1 && call.floor > e.currentFloor) score += 2;
          }
        }
        const loadRatio = e.people.length / e.capacity;
        score += loadRatio * 3;

        if (career.tech.dispatch >= 2) score -= 0.3;

        const b = settings.buildings[e.building];
        if (b && b.type==='hospital' && e.hospitalPriority) {
          if (call.floor<=3) score -= 3.5;
          if (call.dir==='down') score -= 1.5;
        }

        if (score < bestScore) { bestScore = score; chosen = e; }
      });
    }
    if (!chosen) return;
    call.assigned = chosen.id;
    addStop(chosen, call.floor, 'hall');
    logEvent(`AI æŠ¢æ¢¯ï¼š${chosen.name} å¤„ç† ${call.floor}F ${call.dir === 'up' ? 'â†‘' : 'â†“'} å‘¼å«`, 'info');
  }

  function addStop(e, floor) {
    if (floor < 1 || floor > settings.floors) return;
    if (e.stops.includes(floor)) return;
    if (floor === e.currentFloor && e.doorOpen) return;
    e.stops.push(floor);
    startElevatorIfIdle(e);
    syncActiveIf(e);
  }

  function startElevatorIfIdle(e) {
    if (e.fault) return;
    if (e.stops.length === 0) return;
    if (e.state === 'IDLE') {
      if (e.doorOpen) closeDoor(e, true);
      else startMovement(e);
    }
  }

  function closeDoor(e, shouldMove) {
    clearTimeout(e.doorTimer);
    clearTimeout(e.autoCloseTimer);
    if (e.doorOpen) {
      e.state = 'DOOR_CLOSING';
      syncActiveIf(e);
      e.doorTimer = setTimeout(() => {
        e.doorOpen = false;
        e.state = 'IDLE';
        syncActiveIf(e);
        if (shouldMove) startMovement(e);
      }, e.doorTime * 1000);
    } else {
      if (shouldMove) startMovement(e);
    }
  }

  function openDoor(e, onOpened) {
    clearTimeout(e.doorTimer);
    clearTimeout(e.autoCloseTimer);
    e.state = 'DOOR_OPENING';
    syncActiveIf(e);

    e.doorTimer = setTimeout(() => {
      e.doorOpen = true;
      e.state = 'DOOR_OPEN';
      syncActiveIf(e);
      if (typeof onOpened === 'function') onOpened();
      e.autoCloseTimer = setTimeout(() => {
        if (e.state === 'DOOR_OPEN' && !e.fault) closeDoor(e, true);
      }, 3000);
    }, e.doorTime * 1000);
  }

  function startMovement(e) {
    if (e.stops.length === 0 || e.fault) return;

    let target = null;
    let bestDist = Infinity;
    e.stops.forEach(f => {
      const d = Math.abs(f - e.currentFloor);
      if (d < bestDist) { bestDist = d; target = f; }
    });
    if (target == null) { e.state = 'IDLE'; syncActiveIf(e); return; }
    if (target === e.currentFloor) { arriveAtFloor(e); return; }

    e.direction = target > e.currentFloor ? 1 : -1;
    e.state = e.direction === 1 ? 'MOVING_UP' : 'MOVING_DOWN';

    if (!e.moveTimer) { movingCount++; updateMotorSound(); }

    e.moveTimer = setInterval(() => {
      if (settings.randomFaults) {
        let faultProb = 0.009 - career.maintenanceLevel * 0.0015 - career.tech.reliability * 0.0015;
        faultProb = clamp(faultProb, 0.0015, 0.012);
        if (Math.random() < faultProb) { triggerFault(e, 'RANDOM_STOP'); return; }
      }

      e.currentFloor += e.direction;
      e.currentFloor = clamp(e.currentFloor, 1, settings.floors);

      const interior = document.querySelector('.interior-back');
      interior.style.transform = `translateY(${e.direction * 5}px)`;
      setTimeout(() => interior.style.transform = 'translateY(0)', 100);

      syncActiveIf(e);

      if (e.stops.includes(e.currentFloor)) stopAtCurrentFloor(e);
    }, e.speedPerFloor * 1000);

    if (settings.randomFaults) shaft.classList.add('shaking');
    syncActiveIf(e);
  }

  function stopAtCurrentFloor(e) {
    clearInterval(e.moveTimer);
    e.moveTimer = null;
    movingCount = Math.max(0, movingCount - 1);
    updateMotorSound();
    shaft.classList.remove('shaking');

    e.state = 'IDLE';
    e.stops = e.stops.filter(f => f !== e.currentFloor);
    arriveAtFloor(e);
  }

  function arriveAtFloor(e) {
    const floor = e.currentFloor;
    ensureAudio(); playDing();

    hallCalls.forEach(call => {
      if (!call.served && call.building===e.building && call.floor === floor && call.assigned === e.id) {
        call.served = true;
        if (call.building===settings.currentBuilding) {
          const btn = document.querySelector(`.floor-row[data-floor="${floor}"] .hall-btn.${call.dir}`);
          if (btn) btn.classList.remove('active');
        }
      }
    });

    handleDisembark(e, floor);
    openDoor(e, () => {
      handleBoarding(e, floor);
      const btn = document.getElementById(`cab-btn-${floor}`);
      if (btn) btn.classList.remove('pressed');
    });
  }

  function handleDisembark(e, floor) {
    const leavingIds = e.people.filter(pid => {
      const p = passengers.find(pp => pp.id === pid);
      return p && p.to === floor;
    });

    if (leavingIds.length) {
      leavingIds.forEach(pid => {
        const p = passengers.find(pp => pp.id === pid);
        if (p) {
          p.state = 'done';
          p.inElevator = null;

          if (gameMode === 'career') {
            let repDelta = 0;
            if (p.mood >= 70) repDelta = (p.trait==='enthusiast'?2:1);
            else if (p.mood <= 30) repDelta = -2;

            // æ‘„å½±å¤§èµ› Buffï¼šå£ç¢‘æ”¶ç›Šå¢å¼º
            repDelta *= career.buffs.repGainMult;

            career.reputation = clamp(career.reputation + repDelta, 0, 100);
            if (repDelta < 0) career.complaints += 1;

            let price = career.ticketPrice;
            if (festival && career.day<=festival.endsAtDay) price *= festival.priceMult;

            // çˆ±å¥½è€…å°è´¹ï¼šBuff æå‡å°è´¹æ¦‚ç‡å’Œå¹…åº¦
            if (p.trait==='enthusiast' && p.mood>=80 && Math.random()<0.35*career.buffs.tipMult){
              price += 1;
              logEvent(`P${p.id}ï¼ˆçˆ±å¥½è€…ï¼‰å¼€å¿ƒæ‰“èµ +1 å…ƒ`, 'info');
            }
            career.money += price;
            career.servedToday += 1;

            if (p.trait==='enthusiast') {
              career.stats.fansServed += 1;
              career.stats.fansServedToday += 1;
              maybeTriggerPhotoContest(p);
            }
          }

          p.mood = Math.min(100, p.mood + 10);
          maybeSay(p, 'leave');

          if (p.trait==='enthusiast' && Math.random()<0.28){
            const from = floor;
            let to = randomInt(1, settings.floors);
            if (to===from) to = from===settings.floors?from-1:from+1;
            const np = makePassenger(from,to,p.building,'enthusiast');
            np.mood = clamp(p.mood + 10, 50, 100);
            passengers.push(np);
            hallCall(from, to>from?'up':'down', np);
            if (p.building===settings.currentBuilding){
              logEvent(`ç”µæ¢¯çˆ±å¥½è€… P${p.id} è¯´ï¼šå†åä¸€è¶Ÿï¼ (ç”Ÿæˆ P${np.id})`, 'say');
            }
          }
        }
      });
      e.people = e.people.filter(pid => !leavingIds.includes(pid));
      logEvent(`${e.name} åœ¨ ${floor}F ä¸‹å®¢ ${leavingIds.length} äºº`, 'info');
      updateCareerUI();
    }
  }

  function handleBoarding(e, floor) {
    const waiting = passengers.filter(p => p.state === 'waiting' && p.from === floor && p.building===e.building);
    if (!waiting.length) return;

    waiting.sort((a, b) => b.waitTime - a.waitTime);

    let boarded = [];
    for (const p of waiting) {
      if (e.people.length >= e.capacity) break;
      p.state = 'onboard';
      p.inElevator = e.id;

      // æ¢¯æ¯ä¸Šè½¦ä¼šâ€œç»§ç»­ä¼ªè£…â€ï¼Œç›´åˆ°éœ²é¦…
      // è‹¥å·²ç»éœ²é¦…åˆ™ä¸å˜
      if (p.trait==='saboteur' && p.disguised) {
        if (Math.random()<0.15) revealSaboteur(p, 'board_reveal');
      }

      e.people.push(p.id);
      addStop(e, p.to);
      boarded.push(p);
      maybeSay(p, 'board');

      if (p.trait==='enthusiast' && Math.random()<0.5){
        maybeSay(p,'fan_photo');
        if (gameMode==='career'){
          career.reputation = clamp(career.reputation + 1*career.buffs.repGainMult,0,100);
        }
      }
    }

    if (boarded.length) logEvent(`${e.name} åœ¨ ${floor}F ä¸Šå®¢ ${boarded.length} äºº`, 'info');

    const stillWaiting = passengers.some(p => p.state === 'waiting' && p.from === floor && p.building===e.building);
    ['up', 'down'].forEach(dir => {
      if (e.building===settings.currentBuilding) {
        const btn = document.querySelector(`.floor-row[data-floor="${floor}"] .hall-btn.${dir}`);
        if (btn && !stillWaiting) btn.classList.remove('active');
      }
    });

    updateHeatmap();
    syncActiveIf(e);
  }

  function restartSpawnTimer() {
    if (spawnTimer) clearInterval(spawnTimer);

    const base = 12000, min = 2000;
    const span = base - min;
    const level = settings.traffic;
    let t = base - ((level - 1) * (span / 9));

    if (festival && career.day<=festival.endsAtDay) t *= festival.trafficMult;

    spawnTimer = setInterval(spawnRandomPassenger, t);
  }

  function makePassenger(from,to,bidx,trait){
    const personality = randomInt(1, 3);
    const impatientBoost = (BUILDING_TYPES[settings.buildings[bidx].type].patienceBias || 1);

    let moodBase = randomInt(65, 100);
    if (trait==='enthusiast') moodBase = randomInt(80, 100);
    if (trait==='saboteur') moodBase = randomInt(45, 80);

    return {
      id: nextPassengerId++,
      from,
      to,
      state: 'waiting',
      waitTime: 0,
      mood: moodBase,
      personality: clamp(personality * impatientBoost, 1, 3),
      inElevator: null,
      building: bidx,
      trait: trait || 'normal',
      didSabotage: false,
      disguised: trait==='saboteur' ? true : false,  // âœ… æ¢¯æ¯ä¼ªè£…
      revealedAt: null
    };
  }

  function spawnRandomPassenger() {
    if (!simulationRunning) return;

    const bidx = randomInt(0, settings.buildings.length-1);
    const b = settings.buildings[bidx];
    const bias = BUILDING_TYPES[b.type];

    let from, to;
    if (bias.trafficBias === 'commute') {
      from = randomInt(1, Math.min(3, settings.floors));
      to = randomInt(Math.ceil(settings.floors*0.6), settings.floors);
    } else if (bias.trafficBias === 'mid') {
      from = randomInt(Math.floor(settings.floors*0.3), Math.floor(settings.floors*0.7));
      to = randomInt(1, settings.floors);
    } else {
      from = randomInt(1, settings.floors);
      to = randomInt(1, settings.floors);
    }
    if (to === from) to = from === settings.floors ? from - 1 : from + 1;

    let trait = 'normal';
    const r = Math.random();

    // æ‘„å½±å¤§èµ› Buffï¼šçˆ±å¥½è€…æ›´å®¹æ˜“å‡ºç°
    const fanProb = 0.08 * career.buffs.fanSpawnMult; // é»˜è®¤ 8%ï¼Œbuff æ—¶æ›´é«˜
    if (r < fanProb) trait = 'enthusiast';
    else {
      let sabProb = 0.03;
      if (gameMode==='career' && career.policies.securityPatrol) sabProb *= 0.4;
      if (r < fanProb + sabProb) trait = 'saboteur';
    }

    const p = makePassenger(from,to,bidx,trait);
    passengers.push(p);
    const dir = to > from ? 'up' : 'down';
    hallCall(from, dir, p);

    if (bidx===settings.currentBuilding) {
      logEvent(`ä¹˜å®¢ P${p.id}ï¼ˆ${traitLabelVisible(p)}ï½œ${b.label}ï¼‰åœ¨ ${from}F ç­‰å¾… â†’ ${to}F`, 'info');
      maybeSay(p, 'wait_start');
      updateHeatmap();
    }
  }

  function simTick() {
    if (!simulationRunning) return;

    career.timeMinutes += 5;
    if (career.timeMinutes >= 24 * 60) dailySettlement();

    passengers.forEach(p => {
      if (p.state === 'waiting') {
        p.waitTime += 1;
        if (p.waitTime % 2 === 0) {
          const personality = p.personality || 2;
          let loss = 2 * personality;
          loss -= career.tech.comfort * 0.3;
          if (p.waitTime > 30) loss += 1;

          if (gameMode==='career' && career.policies.crowdGuide) loss *= 0.7;

          if (p.trait==='enthusiast') loss *= 0.5;
          if (p.trait==='saboteur') loss *= 1.3;

          p.mood = Math.max(0, p.mood - loss);

          // æ¢¯æ¯ä¼ªè£…ä¸‹ï¼Œæƒ…ç»ªå¤ªä½æˆ–æ’å¤ªä¹…ï¼Œæœ‰å°æ¦‚ç‡éœ²é¦…
          if (p.trait==='saboteur' && p.disguised){
            const revealProb = (p.mood<20?0.02:0.005) + (p.waitTime>25?0.01:0);
            if (Math.random()<revealProb) revealSaboteur(p,'queue_reveal');
          }

          if (p.waitTime % 8 === 0) maybeSay(p, 'waiting_long');
        }
      } else if (p.state === 'onboard') {
        p.waitTime += 1;
        if (p.waitTime % 4 === 0) {
          const personality = p.personality || 2;
          let loss = 1 * personality;
          const e = elevators.find(x=>x.id===p.inElevator);
          if (e) {
            const ratio = e.people.length / e.capacity;
            if (ratio > 0.8) loss += 2;
            else if (ratio > 0.6) loss += 1;
          }
          loss -= career.tech.comfort * 0.2;

          if (p.trait==='enthusiast') loss *= -0.3;
          if (p.trait==='saboteur') loss *= 1.2;

          p.mood = clamp(p.mood - loss, 0, 100);
          if (p.waitTime % 10 === 0) maybeSay(p, 'onboard');
        }
      }
    });

    // æ¢¯æ¯ç ´åï¼šè½¿å¢å†…å°æ¦‚ç‡äººä¸ºæ•…éšœ
    passengers.forEach(p=>{
      if (p.state==='onboard' && p.trait==='saboteur' && !p.didSabotage){
        let prob = 0.0025;
        if (gameMode==='career' && career.policies.securityPatrol) prob *= 0.35;
        if (Math.random()<prob){
          const e = elevators.find(x=>x.id===p.inElevator);
          if (e && !e.fault){
            p.didSabotage = true;
            revealSaboteur(p,'sabotage');
            triggerFault(e,'SABOTAGE', p);
          }
        }
      }
    });

    passengers.forEach(p => {
      if (p.state === 'waiting' && p.waitTime > 40 && p.mood <= 10 && Math.random() < 0.4) {
        p.state = 'gone';
        if (p.building===settings.currentBuilding) {
          logEvent(`ä¹˜å®¢ P${p.id} å› ç­‰å¾…è¿‡ä¹…æ„¤ç„¶ç¦»å¼€ã€‚`, 'warn');
          maybeSay(p, 'leave_angry');
        }
        if (gameMode === 'career') {
          career.reputation = Math.max(0, career.reputation - 3);
          career.complaints += 1;
        }
      }
    });

    if (gameMode === 'career' && career.day % 5 === 0 && lastFestivalDay !== career.day && career.timeMinutes >= 12*60) {
      lastFestivalDay = career.day;
      triggerFestivalEventThemed();
      restartSpawnTimer();
    }

    if (gameMode === 'career' && career.reputation <= 45 && lastOwnerGroupDay !== career.day && Math.random() < 0.015) {
      lastOwnerGroupDay = career.day;
      triggerOwnerGroupEvent();
    }

    const conflictMultGuide = (gameMode==='career' && career.policies.crowdGuide) ? 0.6 : 1;

    for (let f = 1; f <= settings.floors; f++) {
      settings.buildings.forEach((b, bidx)=>{
        const waiting = passengers.filter(p => p.state === 'waiting' && p.from === f && p.building===bidx);
        if (waiting.length >= 2) {
          const angry = waiting.filter(p => p.mood <= 25);
          if (angry.length >= 2 && Math.random() < (festival?festival.conflictMult:1)*0.25*conflictMultGuide) {
            triggerFightEvent(f, bidx, waiting);
          }
        }
      });
    }

    elevators.forEach(e => {
      const ratio = e.people.length / e.capacity;
      if (ratio >= 0.9 && e.people.length >= 3) {
        const onboard = e.people.map(pid => passengers.find(pp => pp.id === pid)).filter(Boolean);
        const angry = onboard.filter(p => p.mood <= 25);
        const now = Date.now();
        if (angry.length >= 2 && Math.random() < (festival?festival.conflictMult:1)*0.2*conflictMultGuide) {
          if (lastCabinConflictAt[e.id] && now - lastCabinConflictAt[e.id] < 15000) return;
          lastCabinConflictAt[e.id] = now;
          triggerCabinConflictEvent(e, angry.slice(0,3));
        }
      }
    });

    updateHeatmap();
    updateStatusLog();
    updateCareerUI();
    checkGameOver();
  }

  // âœ… æ¢¯æ¯éœ²é¦…
  function revealSaboteur(p, reason){
    if (!p || p.trait!=='saboteur' || !p.disguised) return;
    p.disguised = false;
    p.revealedAt = Date.now();

    if (p.building===settings.currentBuilding){
      logEvent(`âš  P${p.id} éœ²å‡ºçœŸé¢ç›®ï¼šç–‘ä¼¼â€œæ¢¯æ¯â€ï¼ï¼ˆ${reason}ï¼‰`, 'error');
      maybeGlobalSay("é‚£äººæœ‰é—®é¢˜ï¼å¿«å«ä¿å®‰ï¼",0.35);
      adTextEl.innerHTML = `âš  è­¦å‘Š<br>P${p.id} è¢«å‘ç°æ˜¯æ¢¯æ¯`;
      adForceUntil = Date.now() + 4500;
    }
  }

  // âœ… ç”µæ¢¯æ‘„å½±å¤§èµ› Buff è§¦å‘
  function maybeTriggerPhotoContest(p){
    if (gameMode!=='career') return;
    if (career.buffs.photoContestUntilDay >= career.day) return; // å·²åœ¨çƒ­åº¦ä¸­
    // è§¦å‘æ¡ä»¶ï¼šå½“å¤©çˆ±å¥½è€…æœåŠ¡ >=5ï¼Œä¸”è¯¥çˆ±å¥½è€…å¿ƒæƒ…å¾ˆé«˜
    if (career.stats.fansServedToday >= 5 && p.mood>=85 && Math.random()<0.25){
      enqueueStory({
        type:'photo_contest',
        title:'ğŸ“¸ ç”µæ¢¯æ‘„å½±å¤§èµ› Â· çƒ­åº¦æ¥è¢­',
        desc:
`ç”µæ¢¯çˆ±å¥½è€…ä»¬ç»„ç»‡äº†â€œç”µæ¢¯æ‘„å½±å¤§èµ›â€ï¼ŒçŸ­è§†é¢‘å¹³å°ç–¯ç‹‚è½¬å‘ã€‚
ä½ ç°åœ¨å¯ä»¥é€‰æ‹©â€œæ”¯æŒ/åˆä½œ/èººå¹³â€ã€‚

è‹¥ä½ æ”¯æŒå¹¶åˆä½œï¼Œæœªæ¥å‡ å¤©å£ç¢‘å¢é•¿æ›´å¿«ï¼Œçˆ±å¥½è€…ä¹Ÿæ›´çˆ±æ¥æ‰“å¡ã€‚`,
        options:[
          { text:'ğŸ¤ å®˜æ–¹åˆä½œ+è®¾ç½®æ‰“å¡ç‚¹', effects:{ money:-800, rep:+6, complaints:-1 }, log:'ä½ é¡ºåŠ¿è”åï¼Œçƒ­åº¦åå“ºå£ç¢‘ï¼', onResolve:()=>activatePhotoBuff(5,'high') },
          { text:'ğŸ‘ é»˜è®¤æ”¯æŒä½†ä¸èŠ±é’±', effects:{ money:0, rep:+2, complaints:0 }, log:'ä½ å£å¤´æ”¯æŒï¼Œçƒ­åº¦ä¸€èˆ¬ã€‚', onResolve:()=>activatePhotoBuff(3,'mid') },
          { text:'ğŸ™ˆ ä¸ç†ä¼šçƒ­åº¦', effects:{ money:0, rep:-3, complaints:+1 }, log:'ä½ é”™è¿‡äº†å¥½æœºä¼šï¼Œè¿˜è¢«åæ§½ã€‚' }
        ]
      });
    }
  }

  function activatePhotoBuff(days, level){
    career.buffs.photoContestUntilDay = career.day + days - 1;
    if (level==='high'){
      career.buffs.repGainMult = 1.25;
      career.buffs.fanSpawnMult = 1.6;
      career.buffs.tipMult = 1.6;
    } else if (level==='mid'){
      career.buffs.repGainMult = 1.12;
      career.buffs.fanSpawnMult = 1.25;
      career.buffs.tipMult = 1.2;
    }
    logEvent(`æ‘„å½±å¤§èµ› Buff ç”Ÿæ•ˆï¼šæŒç»­ ${days} å¤©ï¼ˆå£ç¢‘â†‘/çˆ±å¥½è€…â†‘/å°è´¹â†‘ï¼‰`,'info');
    updateCareerUI();
  }

  function triggerFestivalEventThemed(){
    let theme = 'ç¤¾åŒºèŠ‚';
    let trafficMult = 0.7, priceMult=1.2, conflictMult=1.1;

    if (career.day % 15 === 0) theme = 'å¹´è´§èŠ‚';
    else if (career.day % 10 === 0) theme = 'å¼€å­¦å­£';
    else if (settings.buildings.some(b=>b.type==='hospital')) theme = 'åŒ»é™¢æ€¥è¯Šæ½®';

    if (theme==='å¹´è´§èŠ‚') { trafficMult=0.6; priceMult=1.4; conflictMult=1.25; }
    if (theme==='å¼€å­¦å­£') { trafficMult=0.65; priceMult=1.25; conflictMult=1.15; }
    if (theme==='åŒ»é™¢æ€¥è¯Šæ½®') { trafficMult=0.55; priceMult=1.1; conflictMult=1.35; }

    festival = { theme, endsAtDay: career.day, trafficMult, priceMult, conflictMult };

    const desc =
`ä»Šå¤©æ˜¯ã€${theme}ã€‘ï¼
å®¢æµæš´æ¶¨ï¼Œç”µæ¢¯ä¼šæ›´æŒ¤ã€æ›´å®¹æ˜“åµã€‚
ä½ è¦æ€ä¹ˆç»„ç»‡è¿è¥ï¼Ÿ`;

    const options = theme==='å¹´è´§èŠ‚'
      ? [
          { text:'ğŸ ä¸´æ—¶å¢æ´¾å¼•å¯¼å‘˜', effects:{ money:-600, rep:+5, complaints:-2 }, log:'ä½ è¯·äººç»´æŒç§©åºï¼Œä¹˜æ¢¯ä½“éªŒæ˜æ˜¾å˜å¥½ã€‚' },
          { text:'ğŸ’° å¹´è´§èŠ‚æ¶¨ä»·', effects:{ money:+1800, rep:-6, complaints:+2 }, log:'ä½ è¶èŠ‚æ—¥æ¶¨ä»·ï¼Œé’±å¤šäº†ä½†éª‚å£°ä¹Ÿå¤šã€‚' },
          { text:'ğŸ˜´ ä»»å…¶æ‹¥æŒ¤', effects:{ money:+500, rep:-4, complaints:+3 }, log:'ä½ æ²¡ç®¡ï¼Œé«˜å³°æŒ¤åˆ°ç‚¸ã€‚' }
        ]
      : theme==='å¼€å­¦å­£'
      ? [
          { text:'ğŸ§’ è®¾â€œå­¦ç”Ÿä¼˜å…ˆâ€æç¤º', effects:{ money:-300, rep:+4, complaints:-1 }, log:'ä½ åšäº†å­¦ç”Ÿä¼˜å…ˆæç¤ºï¼Œç¤¾ä¼šè¯„ä»·å¾ˆå¥½ã€‚' },
          { text:'ğŸš€ è°ƒåº¦ç­–ç•¥åé€šå‹¤', effects:{ money:-200, rep:+2, complaints:0 }, log:'ä½ ä¼˜åŒ–è°ƒåº¦ï¼Œæ•ˆç‡æå‡ã€‚' },
          { text:'ğŸ™ˆ ä¸å¤„ç†', effects:{ money:+350, rep:-3, complaints:+2 }, log:'ä½ è£…æ²¡çœ‹è§ï¼Œå®¶é•¿ç¾¤ç‚¸äº†ã€‚' }
        ]
      : theme==='åŒ»é™¢æ€¥è¯Šæ½®'
      ? [
          { text:'ğŸš‘ æ€¥è¯Šæ¥¼å±‚ä¼˜å…ˆè°ƒåº¦', effects:{ money:-500, rep:+6, complaints:-2 }, log:'ä½ è®©æ€¥è¯Šä¼˜å…ˆï¼ŒåŒ»æŠ¤ç‚¹èµã€‚' },
          { text:'ğŸ› ï¸ åŠ å¤§ä¿å…»é¿å…æ•…éšœ', effects:{ money:-900, rep:+5, complaints:-2 }, log:'ä½ æå‰ä¿å…»ï¼Œä»Šå¤©å‡ ä¹æ²¡åæ¢¯ã€‚' },
          { text:'ğŸ˜¶ æ™®é€šè¿è¥', effects:{ money:+400, rep:-5, complaints:+3 }, log:'ä½ ä¸ä¼˜å…ˆæ€¥è¯Šï¼ŒæŠ•è¯‰çˆ†ç‚¸ã€‚' }
        ]
      : [
          { text:'ğŸ“¢ å¹¿æ’­é”™å³°', effects:{ money:-300, rep:+3, complaints:-1 }, log:'ä½ æå‰å¹¿æ’­é”™å³°ï¼Œç§©åºè¾ƒå¥½ã€‚' },
          { text:'ğŸ’° ç¥¨ä»·ä¸´æ—¶ä¸Šè°ƒ', effects:{ money:+1200, rep:-4, complaints:+1 }, log:'ä½ è¶çƒ­æ¶¨ä»·ï¼Œèµšåˆ°äº†ä½†å£ç¢‘å—æŸã€‚' },
          { text:'ğŸ˜´ æ­£å¸¸è¿è¥ä¸ç®¡', effects:{ money:+400, rep:-2, complaints:+2 }, log:'ä½ æ²¡ç‰¹åˆ«å®‰æ’ï¼Œé«˜å³°æŒ¤çˆ†äº†ã€‚' }
        ];

    enqueueStory({
      type:'festival',
      title:`èŠ‚æ—¥æ´»åŠ¨ Â· ${theme}`,
      desc,
      options
    });

    logEvent(`èŠ‚æ—¥ä¸»é¢˜è§¦å‘ï¼š${theme}ï¼ˆå®¢æµ+æ‹¥æŒ¤+æ”¶ç›Šbuffï¼‰`, 'warn');
    maybeGlobalSay(`ä»Šå¤©æ˜¯${theme}å•Šï¼å¤ªæŒ¤äº†ï¼`,0.25);
  }

  function triggerOwnerGroupEvent(){
    career.strikes += 1;

    if (career.strikes >= 2 || career.reputation <= 35) {
      career.voteDaysLeft = 3;
    }

    const desc =
`ä¸šä¸»ç¾¤å¼€å§‹åˆ·å±ï¼š
â€œç”µæ¢¯åˆæ…¢åˆæŒ¤ï¼Œè¿˜è€åï¼â€
â€œç‰©ä¸šåˆ°åº•ç®¡ä¸ç®¡ï¼Ÿâ€

å½“å‰è¿½è´£æ¬¡æ•°ï¼š${career.strikes}
${career.voteDaysLeft!=null ? `âš  è§£é›‡æŠ•ç¥¨å€’è®¡æ—¶ï¼š${career.voteDaysLeft} å¤©` : 'ï¼ˆæš‚æœªè¿›å…¥æŠ•ç¥¨é˜¶æ®µï¼‰'}

ä½ å¿…é¡»å›åº”ã€‚`;

    enqueueStory({
      type:'owners_group',
      title:`ä¸šä¸»ç¾¤ç‚¸é”… Â· ç¬¬${career.strikes}æ¬¡è¿½è´£`,
      desc,
      options:[
        { text:'ğŸ—£ï¸ å…¬å…³é“æ­‰ + æ‰¿è¯ºæ•´æ”¹', effects:{ money:-500, rep:+6, complaints:-2 }, log:'ä½ åŠæ—¶å…¬å…³ï¼Œç¾¤æƒ…ç¼“å’Œã€‚', strikeDelta:-1, voteReset:true },
        { text:'ğŸ› ï¸ ç«‹åˆ»ç ¸é’±å‡çº§ç»´æŠ¤', effects:{ money:-1400, rep:+8, complaints:-3 }, log:'ä½ ç ¸é’±ä¿ç¨³å®šï¼Œå£ç¢‘å›å‡æ˜æ˜¾ã€‚', strikeDelta:-1, voteReset:true },
        { text:'ğŸ™ˆ è£…æ­»ä¸å›', effects:{ money:0, rep:-10, complaints:+4 }, log:'ä½ é€‰æ‹©æ²‰é»˜ï¼Œç¾¤é‡Œå½»åº•ç‚¸è£‚ã€‚', strikeDelta:+1, voteReset:false }
      ]
    });
    logEvent('ä¸šä¸»ç¾¤ç‚¸é”…äº‹ä»¶è§¦å‘ã€‚', 'error');
    updateCareerUI();
  }

  function triggerFightEvent(floor, bidx, waitingList) {
    const now = Date.now();
    const key = `${bidx}-${floor}`;
    if (lastFightAtFloor[key] && now - lastFightAtFloor[key] < 15000) return;
    lastFightAtFloor[key] = now;

    if (bidx===settings.currentBuilding){
      adTextEl.innerHTML = `âš  ${floor}F ä¹˜å®¢å‘ç”Ÿäº‰æ‰§<br>${settings.buildings[bidx].label}`;
      adForceUntil = Date.now() + 6000;
      const moodIcon = document.getElementById(`mood-${floor}`);
      if (moodIcon) moodIcon.textContent = 'ğŸ’¥';
      logEvent(`${settings.buildings[bidx].label} ${floor}F ä¹˜å®¢å‘ç”Ÿäº‰æ‰§`, 'warn');
    }

    waitingList.forEach(p => { p.mood = Math.max(0, p.mood - 12); maybeSay(p,'fight'); });

    enqueueStory({
      type: 'conflict',
      title: `${settings.buildings[bidx].label}Â·${floor}F ä¹˜å®¢å†²çª`,
      desc: `ç­‰å¾…åŒºçˆ†å‘äº‰æ‰§ï¼ŒæŠ•è¯‰å·²ç»åœ¨è·¯ä¸Šã€‚\nä½ æ‰“ç®—æ€ä¹ˆå¤„ç½®ï¼Ÿ`,
      options: [
        { text:'ğŸ“¢ å¹¿æ’­é“æ­‰å¹¶åŠå¯¼', effects:{ money:-200, rep:+2, complaints:-1 }, log:'ä½ å¹¿æ’­é“æ­‰ï¼Œå†²çªç¨æœ‰ç¼“å’Œã€‚' },
        { text:'ğŸ‘® å«ä¿å®‰ä»‹å…¥', effects:{ money:-500, rep:+4, complaints:-2 }, log:'ä¿å®‰åˆ°åœºæ‹‰å¼€åŒæ–¹ï¼Œç§©åºæ¢å¤ã€‚' },
        { text:'ğŸ˜¶ è£…æ­»ä¸ç®¡', effects:{ money:0, rep:-6, complaints:+2 }, log:'ä½ é€‰æ‹©æ— è§†ï¼ŒæŠ•è¯‰è¿…é€Ÿå‡çº§ã€‚' }
      ]
    });
  }

  function triggerCabinConflictEvent(e, angryPassengers){
    if (e.building===settings.currentBuilding){
      adTextEl.innerHTML = `âš  è½¿å¢å†…å‘ç”Ÿå†²çª<br>${e.name.split('ï½œ')[0]} è¿‡åº¦æ‹¥æŒ¤`;
      adForceUntil = Date.now() + 6000;
      logEvent(`${e.name} è½¿å¢è¿‡æŒ¤å¼•å‘ä¹˜å®¢å£è§’`, 'warn');
    }
    angryPassengers.forEach(p => { p.mood = Math.max(0, p.mood - 15); maybeSay(p,'fight'); });

    enqueueStory({
      type:'cabin_conflict',
      title:`${e.name.split('ï½œ')[0]} Â· è½¿å¢æ‹¥æŒ¤å†²çª`,
      desc:`ç”µæ¢¯å†…å¤ªæŒ¤ï¼Œæœ‰ä¹˜å®¢äº’ç›¸æŒ‡è´£ç”šè‡³è¦åŠ¨æ‰‹ã€‚\nä½ è¦ç«‹å³å¤„ç½®å—ï¼Ÿ`,
      options:[
        { text:'ğŸ“¢ å¹¿æ’­è‡´æ­‰+æé†’åˆ†æµ', effects:{ money:-300, rep:+3, complaints:-1 }, log:'ä½ ç”¨å¹¿æ’­ç¨³ä½æƒ…ç»ªï¼Œå¹¶å»ºè®®é”™å³°ã€‚' },
        { text:'ğŸš¨ ç´§æ€¥åœæ¢¯å¹¶å«ä¿å®‰', effects:{ money:-800, rep:+6, complaints:-2 }, log:'ä½ å¼ºåˆ¶åœæ¢¯å¤„ç†ï¼Œè™½ç„¶èŠ±é’±ä½†æ•ˆæœå¥½ã€‚' },
        { text:'ğŸ™ˆ è£…æ­»ä¸ç®¡', effects:{ money:0, rep:-8, complaints:+3 }, log:'ä½ æ”¾ä»»å†²çªæ‰©æ•£ï¼Œå£ç¢‘æš´è·Œã€‚' }
      ]
    });
  }

  function enqueueStory(story){
    const id = nextStoryId++;
    storyQueue.push({ id, ...story, createdAt: Date.now() });
    if (!focusedStoryId) focusedStoryId = id;
    renderStoryUI();
    maybeGlobalSay("æœ‰çªå‘äº‹ä»¶ï¼å»ã€å‰§æƒ…/äº‹ä»¶ã€‘å¤„ç†ä¸€ä¸‹ã€‚", 0.2);
  }

  function renderStoryUI(){
    storyQueueEl.innerHTML = '';
    if (storyQueue.length === 0){
      storyQueueEl.innerHTML = '<div style="color:#666;">ï¼ˆç©ºï¼‰</div>';
      storyCurrentEl.innerHTML = `
        <div class="story-title">æš‚æ— äº‹ä»¶</div>
        <div class="story-desc">ç”µæ¢¯é‡Œé£å¹³æµªé™ã€‚</div>
        <div class="story-options"></div>
        <div class="story-hint">æç¤ºï¼šæ‹¥æŒ¤å†²çªã€èŠ‚æ—¥ã€ä¸šä¸»ç¾¤ã€æ¢¯æ¯ã€æ‘„å½±å¤§èµ›éƒ½ä¼šè¿›å…¥è¿™é‡Œã€‚</div>
      `;
      focusedStoryId = null;
      return;
    }

    storyQueue.forEach(s=>{
      const item = document.createElement('div');
      item.className = 'queue-item' + (s.id === focusedStoryId ? ' active':'');
      item.textContent = `#${s.id}  ${s.title}`;
      item.addEventListener('click', ()=>{
        focusedStoryId = s.id;
        renderStoryUI();
      });
      storyQueueEl.appendChild(item);
    });

    const cur = storyQueue.find(s=>s.id===focusedStoryId) || storyQueue[0];
    focusedStoryId = cur.id;

    const optHtml = cur.options.map((op, idx)=>{
      const eff = op.effects || {};
      const effStr = [
        eff.money ? `èµ„é‡‘${eff.money>0?'+':''}${eff.money}` : null,
        eff.rep ? `å£ç¢‘${eff.rep>0?'+':''}${eff.rep}` : null,
        eff.complaints ? `æŠ•è¯‰${eff.complaints>0?'+':''}${eff.complaints}` : null
      ].filter(Boolean).join(' / ');
      return `<button class="story-btn" data-idx="${idx}">${op.text}${effStr?`<div style="font-size:11px;color:#aaa;margin-top:2px;">å½±å“ï¼š${effStr}</div>`:''}</button>`;
    }).join('');

    storyCurrentEl.innerHTML = `
      <div class="story-title">${cur.title}</div>
      <div class="story-desc">${cur.desc}</div>
      <div class="story-options">${optHtml}</div>
      <div class="story-hint">äº‹ä»¶ä¼šå½±å“èµ„é‡‘/å£ç¢‘/æŠ•è¯‰/è¿½è´£/è§£é›‡å€’è®¡æ—¶/Buffã€‚</div>
    `;

    storyCurrentEl.querySelectorAll('.story-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const idx = parseInt(btn.dataset.idx,10);
        resolveStory(cur.id, idx);
      });
    });
  }

  function resolveStory(storyId, optionIdx){
    const sIdx = storyQueue.findIndex(s=>s.id===storyId);
    if (sIdx<0) return;
    const story = storyQueue[sIdx];
    const op = story.options[optionIdx];
    if (!op) return;

    applyEffects(op.effects);

    if (story.type==='owners_group' && gameMode==='career') {
      if (typeof op.strikeDelta==='number') career.strikes = Math.max(0, career.strikes + op.strikeDelta);
      if (op.voteReset) career.voteDaysLeft = null;
      updateCareerUI();
    }

    if (typeof op.onResolve === 'function') op.onResolve();

    logEvent(`äº‹ä»¶å¤„ç½®ï¼š${story.title} -> ${op.log}`, 'info');
    maybeGlobalSay(op.log, 0.15);

    storyQueue.splice(sIdx,1);
    focusedStoryId = storyQueue[0]?.id || null;
    renderStoryUI();
    checkGameOver();
  }

  function applyEffects(eff={}){
    if (gameMode === 'career'){
      if (typeof eff.money === 'number') career.money += eff.money;
      if (typeof eff.rep === 'number') career.reputation = clamp(career.reputation + eff.rep, 0, 100);
      if (typeof eff.complaints === 'number') career.complaints = Math.max(0, career.complaints + eff.complaints);
      updateCareerUI();
    }
  }

  const TECHS = [
    { key:'dispatch', name:'è°ƒåº¦ç®—æ³•å‡çº§', desc:'æå‡ AI æŠ¢æ¢¯æ•ˆç‡ï¼Œå¹¶è§£é”ã€é«˜é€Ÿç”µæ¢¯ã€‘åˆ†æ”¯ã€‚', max:5, baseCost:1500 },
    { key:'comfort', name:'ä¹˜æ¢¯èˆ’é€‚å·¥ç¨‹', desc:'é™ä½ç„¦èºã€æå‡å®¹é‡ï¼Œå¹¶è§£é”ã€å¤§è½½é‡ç”µæ¢¯ã€‘åˆ†æ”¯ã€‚', max:5, baseCost:1200 },
    { key:'reliability', name:'å¯é æ€§å¼ºåŒ–', desc:'å¤§å¹…é™ä½æ•…éšœï¼Œå¹¶è§£é”ã€åŒ»é™¢ä¼˜å…ˆç”µæ¢¯ã€‘åˆ†æ”¯ã€‚', max:5, baseCost:1800 }
  ];

  function techUpgradeCost(key){
    const level = career.tech[key] || 0;
    return Math.round(TECHS.find(t=>t.key===key).baseCost * (1 + level*0.8));
  }

  function renderTechUI(){
    techListEl.innerHTML = '';
    TECHS.forEach(t=>{
      const lv = career.tech[t.key]||0;
      const cost = techUpgradeCost(t.key);
      const item = document.createElement('div');
      item.className = 'tech-item';

      const unlockInfo = getUnlockInfoForTech(t.key, lv);

      item.innerHTML = `
        <div class="tech-title">
          <span>${t.name}</span>
          <span>Lv.${lv}/${t.max}</span>
        </div>
        <div class="tech-desc">${t.desc}</div>
        <div class="tech-desc" style="color:#ffd54f;">${unlockInfo}</div>
        <button class="tech-btn ${ (gameMode!=='career'||lv>=t.max||career.money<cost) ? 'disabled':'' }" data-key="${t.key}">
          å‡çº§ï¼ˆ${cost} å…ƒï¼‰
        </button>
      `;
      techListEl.appendChild(item);
    });

    techListEl.querySelectorAll('.tech-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if (gameMode!=='career') return;
        const key = btn.dataset.key;
        const t = TECHS.find(x=>x.key===key);
        const lv = career.tech[key]||0;
        if (lv>=t.max) return;
        const cost = techUpgradeCost(key);
        if (career.money<cost) { logEvent('èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•å‡çº§ç§‘æŠ€ã€‚','warn'); return; }
        career.money-=cost;
        career.tech[key]=lv+1;
        logEvent(`ç§‘æŠ€å‡çº§ï¼š${t.name} -> Lv.${career.tech[key]}ï¼ˆèŠ±è´¹ ${cost} å…ƒï¼‰`,'info');
        renderTechUI();
        updateCareerUI();
        initSystem();
      });
    });
  }

  function getUnlockInfoForTech(key, lv){
    if (key==='dispatch') return lv>=3 ? 'âœ… å·²è§£é”ï¼šé«˜é€Ÿç”µæ¢¯å‹å·' : 'Lv.3 è§£é”ï¼šé«˜é€Ÿç”µæ¢¯';
    if (key==='comfort') return lv>=3 ? 'âœ… å·²è§£é”ï¼šå¤§è½½é‡ç”µæ¢¯å‹å·' : 'Lv.3 è§£é”ï¼šå¤§è½½é‡ç”µæ¢¯';
    if (key==='reliability') return lv>=3 ? 'âœ… å·²è§£é”ï¼šåŒ»é™¢ä¼˜å…ˆç”µæ¢¯å‹å·' : 'Lv.3 è§£é”ï¼šåŒ»é™¢ä¼˜å…ˆç”µæ¢¯';
    return '';
  }

  function isUnlocked(modelKey){
    const m = ELEVATOR_MODELS_UNLOCK[modelKey];
    const need = m.need;
    return Object.keys(need).every(k => (career.tech[k]||0) >= need[k]);
  }

  function getAvailableModelsForBuilding(btype){
    const models = [...ELEVATOR_MODELS_BASE];
    if (isUnlocked('highspeed')) models.push(ELEVATOR_MODELS_UNLOCK.highspeed);
    if (isUnlocked('heavyload')) models.push(ELEVATOR_MODELS_UNLOCK.heavyload);
    if (btype==='hospital' && isUnlocked('hospitalP')) models.push(ELEVATOR_MODELS_UNLOCK.hospitalP);
    return models;
  }

  function pickModelForBuilding(models, btype){
    if (btype==='hospital'){
      const hp = models.find(m=>m.key==='hospitalP');
      if (hp) return hp;
    }
    const hs = models.find(m=>m.key==='highspeed');
    const hl = models.find(m=>m.key==='heavyload');
    if (hs && Math.random()<0.6) return hs;
    if (hl && Math.random()<0.5) return hl;
    return models[Math.floor(Math.random()*models.length)];
  }

  function updateHeatmap() {
    const bidx = settings.currentBuilding;
    const waitingCounts = new Array(settings.floors + 1).fill(0);
    const moodSum = new Array(settings.floors + 1).fill(0);
    const moodNum = new Array(settings.floors + 1).fill(0);

    passengers.forEach(p => {
      if (p.state === 'waiting' && p.building===bidx) {
        waitingCounts[p.from]++;
        moodSum[p.from] += p.mood;
        moodNum[p.from]++;
      }
    });

    for (let f = 1; f <= settings.floors; f++) {
      const inner = document.getElementById(`heat-${f}`);
      const moodIcon = document.getElementById(`mood-${f}`);
      if (!inner || !moodIcon) continue;

      const count = waitingCounts[f];
      const perc = Math.min(100, count * 20);
      inner.style.width = perc + '%';
      inner.style.opacity = count > 0 ? 0.8 : 0.15;

      let avg = 100;
      if (moodNum[f]) avg = moodSum[f] / moodNum[f];
      let icon = 'ğŸ˜„';
      if (avg < 70) icon = 'ğŸ˜';
      if (avg < 40) icon = 'ğŸ˜¡';
      moodIcon.textContent = count === 0 ? '' : icon;
    }
  }

  function triggerFault(e, type, culpritPassenger) {
    clearInterval(e.moveTimer);
    e.moveTimer = null;
    movingCount = Math.max(0, movingCount - 1);
    updateMotorSound();
    clearTimeout(e.doorTimer);
    clearTimeout(e.autoCloseTimer);

    e.fault = type || 'FAULT';
    e.state = 'FAULT';
    e.direction = 0;
    e.doorOpen = true;

    shaft.classList.remove('shaking');
    syncActiveIf(e);

    if (e.building===settings.currentBuilding){
      logEvent(`${e.name} å‘ç”Ÿæ•…éšœï¼š${faultLabel(type)}`, 'error');
      adTextEl.innerHTML = `${e.name}<br>æ•…éšœåœè¿`;
      adForceUntil = Date.now() + 6000;
      maybeGlobalSay(type==='SABOTAGE'?"æœ‰äººåœ¨é‡Œé¢æç ´åï¼Ÿï¼":"åˆåäº†ï¼Ÿï¼", 0.25);
    }

    if (gameMode === 'career') {
      let repLoss = 4, compAdd = 1;
      if (type==='SABOTAGE'){
        repLoss = career.policies.securityPatrol ? 3 : 6;
        compAdd = career.policies.securityPatrol ? 1 : 2;
        career.stats.sabotageIncidents += 1;
      }
      career.reputation = Math.max(0, career.reputation - repLoss);
      career.complaints += compAdd;
      updateCareerUI();
    }

    if (type==='SABOTAGE'){
      const pid = culpritPassenger ? culpritPassenger.id : '?';
      enqueueStory({
        type:'sabotage',
        title:`${e.name} Â· äººä¸ºç ´åæ•…éšœ`,
        desc:`ç›‘æ§æ˜¾ç¤ºç–‘ä¼¼â€œæ¢¯æ¯â€åœ¨è½¿å¢å†…ç ´åæŒ‰é’®/é—¨é”ã€‚\nä¹˜å®¢ææ…Œï¼Œåª’ä½“ä¹Ÿå¯èƒ½é—»é£è€Œæ¥ã€‚\n\nå«Œç–‘ä¹˜å®¢ï¼šP${pid}\nä½ è¦æ€ä¹ˆåŠï¼Ÿ`,
        options:[
          { text:'ğŸ‘® ç«‹åˆ»æŠ¥è­¦ + å°é—­ä¹˜æ¢¯åŒº', effects:{ money:-800, rep:+4, complaints:-2 }, log:'ä½ æœæ–­å¤„ç½®ï¼Œèˆ†è®ºåè½¬ã€‚' },
          { text:'ğŸ› ï¸ åŠ æ€¥ç»´ä¿® + èµ”å¿ä¹˜å®¢', effects:{ money:-600, rep:+2, complaints:-1 }, log:'ä½ å¿«é€Ÿä¿®å¤å¹¶å®‰æŠšä¹˜å®¢ã€‚' },
          { text:'ğŸ™ˆ å°½é‡ä½è°ƒå¤„ç†', effects:{ money:-200, rep:-4, complaints:+2 }, log:'ä½ å‹æ¶ˆæ¯ï¼Œä½†å£ç¢‘ä»å—æŸã€‚' }
        ]
      });
      return;
    }

    enqueueStory({
      type:'fault',
      title:`${e.name} Â· çªå‘æ•…éšœ`,
      desc:`ç”µæ¢¯è¿è¡Œä¸­çªç„¶åœæ¢¯ï¼Œä¹˜å®¢æƒ…ç»ªä¸ç¨³ã€‚\nè¦æ€ä¹ˆå®‰æŠšä¸å¤„ç†ï¼Ÿ`,
      options:[
        { text:'ğŸ“¢ ç«‹å³å¹¿æ’­è§£é‡Š+è‡´æ­‰', effects:{ money:-150, rep:+1, complaints:-1 }, log:'ä½ åŠæ—¶è§£é‡Šï¼Œä¹˜å®¢ç¨å®‰ã€‚' },
        { text:'ğŸ› ï¸ æ´¾ç»´ä¿®åŠ æ€¥å¤„ç†', effects:{ money:-600, rep:+3, complaints:-1 }, log:'ç»´ä¿®åˆ°ä½ï¼Œæ•…éšœå¿«é€Ÿè§£é™¤ã€‚' },
        { text:'ğŸ™ˆ æ”¾ç€å…ˆä¸ç®¡', effects:{ money:0, rep:-5, complaints:+2 }, log:'ä½ æ‹–å»¶å¤„ç†ï¼ŒæŠ•è¯‰å‡çº§ã€‚' }
      ]
    });
  }

  function clearFault(e) {
    e.fault = null;
    e.state = 'IDLE';
    e.doorOpen = true;
    if (e.building===settings.currentBuilding){
      logEvent(`${e.name} æ•…éšœå·²æ¸…é™¤ï¼Œé‡æ–°æŠ•å…¥è¿è¡Œ`, 'info');
      adTextEl.innerHTML = `${e.name}<br>ç»´ä¿®å®Œæˆ`;
      adForceUntil = Date.now() + 4000;
    }
    syncActiveIf(e);
  }

  function startAdLoop() {
    if (adTimer) clearInterval(adTimer);
    const ads = [
      "æ˜Ÿç›ç”µæ¢¯ 7000ç³»åˆ—<br>é™¤äº†æ…¢ æ²¡æœ‰ç¼ºç‚¹",
      "ç¾¤æ§æç¤ºï¼š<br>é«˜å³°æœŸè¯·é”™å³°ä¹˜æ¢¯",
      "ä»Šæ—¥å®éªŒï¼š<br>AI æ­£åœ¨å­¦ä¹ ä½ çš„ä¸Šç­æ—¶é—´",
      "å®‰å…¨æé†’ï¼š<br>æƒ…ç»ªæ¿€åŠ¨è¯·å…ˆæ·±å‘¼å¸",
      "ç¤¾åŒºé€šçŸ¥ï¼š<br>ä¸¥ç¦ç”µç“¶è½¦ä¸Šæ¥¼",
      "ç”µæ¢¯çˆ±å¥½è€…æŠ•ç¨¿ï¼š<br>â€œä»Šå¤©åˆåäº† 23 è¶Ÿï¼â€",
      "æ‘„å½±å¤§èµ›çƒ­æ¦œï¼š<br>#ç”µæ¢¯æ‰“å¡æŒ‘æˆ˜"
    ];
    adTimer = setInterval(() => {
      if (Date.now() < adForceUntil) return;
      const anyOpen = elevators.some(e => e.doorOpen);
      if (anyOpen) return;
      const randomAd = ads[Math.floor(Math.random() * ads.length)];
      adTextEl.innerHTML = randomAd;
    }, 5000);
  }

  function maybeGlobalSay(text, prob=0.15){
    if (Math.random() < prob){
      adTextEl.innerHTML = `ğŸ’¬ ä¹˜å®¢ï¼š<br>${escapeHTML(text)}`;
      adForceUntil = Date.now() + 3500;
    }
  }

  function maybeSay(p, ctx){
    if (p.building!==settings.currentBuilding) return;
    const line = randomSpeech(ctx, p);
    if (!line) return;
    logEvent(`P${p.id}ï¼š${line}`, 'say');
    maybeGlobalSay(line, 0.18);
  }

  function randomSpeech(ctx, p){
    const LINES = {
      wait_start: ["å“åˆæ’é˜Ÿâ€¦", "å¸Œæœ›å¿«ç‚¹æ¥ã€‚", "ç”µæ¢¯åˆ«åˆåå§ï¼Ÿ"],
      waiting_long: ["è¿™ä¹Ÿå¤ªä¹…äº†å§ã€‚", "æˆ‘éƒ½å¿«è¿Ÿåˆ°äº†ï¼", "æ€ä¹ˆè¿˜ä¸åˆ°ï¼"],
      board: ["ç»ˆäºä¸Šæ¥äº†ã€‚", "éº»çƒ¦è®©ä¸€ä¸‹ã€‚", "åˆ«æŒ¤åˆ«æŒ¤ï¼"],
      onboard: ["å¥½æŒ¤å•Šâ€¦", "è¿™è¶Ÿèƒ½ä¸åœå—ï¼Ÿ", "å¿«åˆ°å¿«åˆ°ã€‚"],
      leave: ["è°¢è°¢ï¼Œåˆ°äº†ã€‚", "ç»ˆäºè§£è„±ã€‚"],
      leave_angry: ["æˆ‘ä¸ç­‰äº†ï¼", "æŠ•è¯‰ï¼å¿…é¡»æŠ•è¯‰ï¼"],
      fight: ["ä½ æŒ¤ä»€ä¹ˆæŒ¤ï¼", "åˆ«æ¨æˆ‘ï¼", "è¦æ‰“èµ·æ¥å—ï¼Ÿ"],
      fan_photo: ["å˜¿å˜¿æ‹ä¸€ä¸‹æ§åˆ¶é¢æ¿ã€‚", "ç”µæ¢¯ç¯å¥½å¥½çœ‹ï¼", "æˆ‘è¦å‘æœ‹å‹åœˆï¼šä»Šæ—¥ç”µæ¢¯æ‰“å¡ï¼"],
      saboteur: ["è¿™ç”µæ¢¯çœŸçƒ¦ã€‚", "æŒ‰åå®ƒçœ‹ä½ ä»¬æ€ä¹ˆåŠã€‚"]
    };
    const arr = LINES[ctx];
    if (!arr) return null;

    let talkProb = (p.personality||2) * 0.18;
    if (p.trait==='enthusiast') talkProb += 0.12;
    if (p.trait==='saboteur') talkProb += 0.08;

    if (Math.random() > talkProb) return null;
    return arr[Math.floor(Math.random()*arr.length)];
  }

  function updateStatusLog() {
    const b = currentBuilding();
    const curEs = elevators.filter(e=>e.building===settings.currentBuilding);
    const totalWaiting = passengers.filter(p => p.state === 'waiting' && p.building===settings.currentBuilding).length;
    const totalOnboard = passengers.filter(p => p.state === 'onboard' && curEs.some(e=>e.id===p.inElevator)).length;

    const fans = passengers.filter(p=>p.state!=='done' && p.trait==='enthusiast').length;
    const sabTotal = passengers.filter(p=>p.state!=='done' && p.trait==='saboteur').length;
    const sabRevealed = passengers.filter(p=>p.state!=='done' && p.trait==='saboteur' && !p.disguised).length;

    let html = `æ¥¼æ ‹: ${b.label}Â·${BUILDING_TYPES[b.type].name}ï½œæ¨¡å¼: ${gameMode ? (gameMode === 'career' ? 'ç”Ÿæ¶¯' : 'è‡ªç”±') : 'æœªå¼€å§‹'}ï½œæ¥¼å±‚: ${settings.floors}<br>`;
    curEs.forEach(e => {
      html += `${e.name}@F${e.currentFloor} ${stateToLabel(e.state)}${e.fault ? '[æ•…éšœ]' : ''} ä¹˜å®¢ ${e.people.length}/${e.capacity}<br>`;
    });
    html += `ç­‰å¾…: ${totalWaiting} äººï½œè½¦å†…: ${totalOnboard} äººï½œäº‹ä»¶é˜Ÿåˆ—: ${storyQueue.length}<br>`;
    html += `çˆ±å¥½è€…:${fans}ï½œæ¢¯æ¯:${sabRevealed}/${sabTotal}ï¼ˆå·²éœ²é¦…/æ€»æ•°ï¼‰ï½œè¿½è´£:${career.strikes}ï½œæŠ•ç¥¨:${career.voteDaysLeft==null?'-':career.voteDaysLeft+'å¤©'}<br>`;
    if (career.buffs.photoContestUntilDay >= career.day){
      html += `Buff: æ‘„å½±å¤§èµ›çƒ­åº¦ ONï¼ˆå£ç¢‘Ã—${career.buffs.repGainMult.toFixed(2)} çˆ±å¥½è€…Ã—${career.buffs.fanSpawnMult.toFixed(2)} å°è´¹Ã—${career.buffs.tipMult.toFixed(2)}ï¼‰<br>`;
    }
    html += `æ”¿ç­–: å¼•å¯¼å‘˜${career.policies.crowdGuide?'ON':'OFF'} / å®‰ä¿${career.policies.securityPatrol?'ON':'OFF'}`;
    statusLog.innerHTML = html;
  }

  function logEvent(text, type = 'info') {
    const line = document.createElement('div');
    line.className = 'event-line ' + type;
    const time = new Date();
    const tStr = time.toTimeString().slice(0, 8);
    line.textContent = `[${tStr}] ${text}`;
    eventsLog.prepend(line);
    while (eventsLog.childElementCount > 140) eventsLog.removeChild(eventsLog.lastChild);
  }

  function currentBuilding(){
    return settings.buildings[settings.currentBuilding] || settings.buildings[0];
  }

  function buildBuildingUI(){
    buildingButtonsEl.innerHTML = '';
    settings.buildings.forEach((b, idx)=>{
      const btn = document.createElement('div');
      btn.className = 'building-btn' + (idx===settings.currentBuilding?' active':'');
      btn.textContent = b.label;
      btn.addEventListener('click', ()=>{
        settings.currentBuilding = idx;
        saveSettings();
        buildBuildingUI();
        setElevators.value = currentBuilding().elevatorCount;
        buildGroupTabs();
        buildElevatorCards();
        activeElevatorIndex = elevators.filter(e=>e.building===idx)[0]?.id || activeElevatorIndex;
        syncActiveUI();
        updateHeatmap();
        updateStatusLog();
        renderStoryUI();
        restartSpawnTimer();
        logEvent(`åˆ‡æ¢åˆ° ${b.label} è§†è§’ï¼ˆ${BUILDING_TYPES[b.type].name}ï¼‰`, 'info');
      });
      buildingButtonsEl.appendChild(btn);
    });

    const b = currentBuilding();
    const typeInfo = BUILDING_TYPES[b.type];
    const canEdit = gameMode !== 'career';

    buildingCardEl.innerHTML = `
      <div><b>å½“å‰æ¥¼æ ‹ï¼š</b>${b.label}</div>
      <div><b>ç±»å‹ï¼š</b>
        ${canEdit ? `
          <select id="buildingTypeSelect">
            ${Object.keys(BUILDING_TYPES).map(t=>`<option value="${t}" ${t===b.type?'selected':''}>${BUILDING_TYPES[t].name}</option>`).join('')}
          </select>
        ` : `<span style="color:#ffd54f;">${typeInfo.name}</span>ï¼ˆç”Ÿæ¶¯é”å®šï¼‰`}
      </div>
      <div><b>ç”µæ¢¯å°æ•°ï¼š</b>${b.elevatorCount}</div>
      <div><b>å®¢æµç‰¹å¾ï¼š</b>${typeInfo.trafficBias==='commute'?'é€šå‹¤ä¸Šè¡Œå¯†é›†':typeInfo.trafficBias==='mid'?'ä¸­å±‚æ´»è·ƒ':'éšæœºå®¢æµ'}</div>
      <div><b>è€å¿ƒç³»æ•°ï¼š</b>${typeInfo.patienceBias}</div>
    `;

    if (canEdit){
      const sel = document.getElementById('buildingTypeSelect');
      sel.addEventListener('change', ()=>{
        b.type = sel.value;
        saveSettings();
        buildBuildingUI();
        initSystem();
        logEvent(`${b.label} ç±»å‹æ›´æ”¹ä¸º ${BUILDING_TYPES[b.type].name}ï¼ˆè‡ªç”±æ¨¡å¼ï¼‰`, 'info');
      });
    }

    buildingTipEl.textContent = canEdit
      ? 'è‡ªç”±æ¨¡å¼ï¼šå¯éšæ„æ”¹æ¥¼æ ‹ç±»å‹ä¸ç”µæ¢¯æ•°'
      : 'ç”Ÿæ¶¯æ¨¡å¼ï¼šæ¥¼æ ‹ç±»å‹ç”±æ‰©å»ºè®¾å®šï¼Œæ¯æ ‹ç‹¬ç«‹è¿è¥';
  }

  function dailyPriceFactor(){
    const sin = Math.sin(career.day / 3) * 0.15;
    const rnd = (hash(career.day*97 + 13) - 0.5) * 0.08;
    return 1 + sin + rnd;
  }
  function getBuildingExpansionCost(){
    const base = 9000 + settings.buildings.length * 2500;
    return Math.round(base * dailyPriceFactor());
  }
  function getElevatorExpansionCost(){
    const b = currentBuilding();
    const base = 7000 + b.elevatorCount * 3500;
    return Math.round(base * (1 + career.day*0.02));
  }
  function getFloorsExpansionCost(){
    const base = 5000 + settings.floors * 220;
    return Math.round(base * (1 + career.day*0.015));
  }

  function ensureAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
  function updateMotorSound() { movingCount > 0 ? toggleMotorSound(true) : toggleMotorSound(false); }
  function toggleMotorSound(on) {
    ensureAudio();
    if (on && !motorOsc) {
      motorOsc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      motorOsc.connect(gain);
      gain.connect(audioCtx.destination);
      motorOsc.type = 'sawtooth';
      motorOsc.frequency.value = 50;
      gain.gain.value = 0.04;
      motorOsc.start();
    } else if (!on && motorOsc) {
      motorOsc.stop();
      motorOsc = null;
    }
  }
  function playDing() {
    ensureAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.type = 'sine';
    osc.frequency.setValueAtTime(800, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.6);
    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.6);
    osc.start(); osc.stop(audioCtx.currentTime + 0.6);
  }
  function playAlarm() {
    ensureAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.type = 'square';
    osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
    osc.frequency.linearRampToValueAtTime(800, audioCtx.currentTime + 0.3);
    gain.gain.value = 0.2;
    osc.start(); osc.stop(audioCtx.currentTime + 0.3);
  }

  function loadSettings() {
    try {
      const raw = localStorage.getItem(SETTINGS_KEY);
      if (!raw) return { ...SETTINGS_DEFAULT };
      const parsed = JSON.parse(raw);
      const merged = { ...SETTINGS_DEFAULT, ...parsed };
      if (!merged.buildings || !merged.buildings.length) merged.buildings = [...SETTINGS_DEFAULT.buildings];
      merged.buildings.forEach(b=>{
        if (!b.elevatorCount) b.elevatorCount = 1;
        if (!b.type) b.type = 'residential';
        if (!b.label) b.label = 'Aåº§';
      });
      merged.currentBuilding = clamp(merged.currentBuilding||0, 0, merged.buildings.length-1);
      return merged;
    } catch (e) {
      return { ...SETTINGS_DEFAULT };
    }
  }
  function saveSettings() { localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }

  // æ˜¾ç¤ºç”¨ç‰¹è´¨ï¼šæ¢¯æ¯ä¼ªè£…æ—¶å½“æ™®é€š
  function traitLabelVisible(p){
    if (p.trait==='saboteur' && p.disguised) return 'æ™®é€š';
    if (p.trait==='enthusiast') return 'ç”µæ¢¯çˆ±å¥½è€…ğŸ“¸';
    if (p.trait==='saboteur') return 'æ¢¯æ¯ğŸ’£';
    return 'æ™®é€š';
  }
  function traitLabel(t){
    if (t==='enthusiast') return 'ç”µæ¢¯çˆ±å¥½è€…ğŸ“¸';
    if (t==='saboteur') return 'æ¢¯æ¯ğŸ’£';
    return 'æ™®é€š';
  }

  function randomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
  function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }
  function stateToLabel(s) {
    switch (s) {
      case 'IDLE': return 'å¾…æœº';
      case 'MOVING_UP': return 'ä¸Šè¡Œ';
      case 'MOVING_DOWN': return 'ä¸‹è¡Œ';
      case 'DOOR_OPEN': return 'é—¨å¼€';
      case 'DOOR_OPENING': return 'å¼€é—¨ä¸­';
      case 'DOOR_CLOSING': return 'å…³é—¨ä¸­';
      case 'FAULT': return 'æ•…éšœ';
      default: return s;
    }
  }
  function faultLabel(t) {
    if (t === 'RANDOM_STOP') return 'è¿è¡Œä¸­åœæ¢¯';
    if (t === 'SABOTAGE') return 'äººä¸ºç ´åæ•…éšœ';
    return 'æœªçŸ¥æ•…éšœ';
  }
  function formatTime(minutes) {
    const m = ((minutes % (24 * 60)) + (24 * 60)) % (24 * 60);
    const h = Math.floor(m / 60);
    const min = m % 60;
    return `${h.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
  }
  function escapeHTML(str){
    return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]));
  }
  function hash(x){
    x = Math.sin(x) * 10000;
    return x - Math.floor(x);
  }
</script>
</body>
</html>
